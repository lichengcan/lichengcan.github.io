(window.webpackJsonp=window.webpackJsonp||[]).push([[26],{444:function(e,v,_){"use strict";_.r(v);var t=_(2),n=Object(t.a)({},(function(){var e=this,v=e._self._c;return v("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[v("h1",{attrs:{id:"_1-ç®€ä»‹"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_1-ç®€ä»‹"}},[e._v("#")]),e._v(" 1. ç®€ä»‹")]),e._v(" "),v("p",[e._v("CLH åŒæ­¥é˜Ÿåˆ—æ˜¯ä¸€ä¸ª FIFO "),v("strong",[e._v("åŒå‘")]),e._v("é˜Ÿåˆ—ï¼ŒAQS ä¾èµ–å®ƒæ¥å®ŒæˆåŒæ­¥çŠ¶æ€çš„ç®¡ç†ï¼š")]),e._v(" "),v("ul",[v("li",[e._v("å½“å‰çº¿ç¨‹å¦‚æœè·å–åŒæ­¥çŠ¶æ€å¤±è´¥æ—¶ï¼ŒAQSåˆ™ä¼šå°†å½“å‰çº¿ç¨‹å·²ç»ç­‰å¾…çŠ¶æ€ç­‰ä¿¡æ¯æ„é€ æˆä¸€ä¸ªèŠ‚ç‚¹ï¼ˆNodeï¼‰å¹¶å°†å…¶åŠ å…¥åˆ°CLHåŒæ­¥é˜Ÿåˆ—ï¼ŒåŒæ—¶ä¼šé˜»å¡å½“å‰çº¿ç¨‹")]),e._v(" "),v("li",[e._v("å½“åŒæ­¥çŠ¶æ€é‡Šæ”¾æ—¶ï¼Œä¼šæŠŠé¦–èŠ‚ç‚¹å”¤é†’ï¼ˆå…¬å¹³é”ï¼‰ï¼Œä½¿å…¶å†æ¬¡å°è¯•è·å–åŒæ­¥çŠ¶æ€ã€‚")])]),e._v(" "),v("h1",{attrs:{id:"_2-node"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_2-node"}},[e._v("#")]),e._v(" 2. Node")]),e._v(" "),v("p",[e._v("åœ¨ CLH åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œ"),v("strong",[e._v("ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆNodeï¼‰ï¼Œè¡¨ç¤ºä¸€ä¸ªçº¿ç¨‹")]),e._v("ï¼Œå®ƒä¿å­˜ç€çº¿ç¨‹çš„å¼•ç”¨ï¼ˆ"),v("code",[e._v("thread")]),e._v("ï¼‰ã€çŠ¶æ€ï¼ˆ"),v("code",[e._v("waitStatus")]),e._v("ï¼‰ã€å‰é©±èŠ‚ç‚¹ï¼ˆ"),v("code",[e._v("prev")]),e._v("ï¼‰ã€åç»§èŠ‚ç‚¹ï¼ˆ"),v("code",[e._v("next")]),e._v("ï¼‰ã€‚å…¶å®šä¹‰å¦‚ä¸‹ï¼š")]),e._v(" "),v("blockquote",[v("p",[e._v("Node æ˜¯ AbstractQueuedSynchronizer çš„å†…éƒ¨é™æ€ç±»ã€‚")])]),e._v(" "),v("div",{staticClass:"language- extra-class"},[v("pre",{pre:!0,attrs:{class:"language-text"}},[v("code",[e._v("static final class Node {\n\n    // å…±äº«\n    static final Node SHARED = new Node();\n    // ç‹¬å \n    static final Node EXCLUSIVE = null;\n\n    /**\n     * å› ä¸ºè¶…æ—¶æˆ–è€…ä¸­æ–­ï¼ŒèŠ‚ç‚¹ä¼šè¢«è®¾ç½®ä¸ºå–æ¶ˆçŠ¶æ€ï¼Œè¢«å–æ¶ˆçš„èŠ‚ç‚¹æ—¶ä¸ä¼šå‚ä¸åˆ°ç«äº‰ä¸­çš„ï¼Œä»–ä¼šä¸€ç›´ä¿æŒå–æ¶ˆçŠ¶æ€ä¸ä¼šè½¬å˜ä¸ºå…¶ä»–çŠ¶æ€\n     */\n    static final int CANCELLED =  1;\n    /**\n     * åç»§èŠ‚ç‚¹çš„çº¿ç¨‹å¤„äºç­‰å¾…çŠ¶æ€ï¼Œè€Œå½“å‰èŠ‚ç‚¹çš„çº¿ç¨‹å¦‚æœé‡Šæ”¾äº†åŒæ­¥çŠ¶æ€æˆ–è€…è¢«å–æ¶ˆï¼Œå°†ä¼šé€šçŸ¥åç»§èŠ‚ç‚¹ï¼Œä½¿åç»§èŠ‚ç‚¹çš„çº¿ç¨‹å¾—ä»¥è¿è¡Œ\n     */\n    static final int SIGNAL    = -1;\n    /**\n     * èŠ‚ç‚¹åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼ŒèŠ‚ç‚¹çº¿ç¨‹ç­‰å¾…åœ¨Conditionä¸Šï¼Œå½“å…¶ä»–çº¿ç¨‹å¯¹Conditionè°ƒç”¨äº†signal()åï¼Œè¯¥èŠ‚ç‚¹å°†ä¼šä»ç­‰å¾…é˜Ÿåˆ—ä¸­è½¬ç§»åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ï¼ŒåŠ å…¥åˆ°åŒæ­¥çŠ¶æ€çš„è·å–ä¸­\n     */\n    static final int CONDITION = -2;\n    /**\n     * è¡¨ç¤ºä¸‹ä¸€æ¬¡å…±äº«å¼åŒæ­¥çŠ¶æ€è·å–ï¼Œå°†ä¼šæ— æ¡ä»¶åœ°ä¼ æ’­ä¸‹å»\n     */\n    static final int PROPAGATE = -3;\n\n    /** ç­‰å¾…çŠ¶æ€ */\n    volatile int waitStatus;\n\n    /** å‰é©±èŠ‚ç‚¹ï¼Œå½“èŠ‚ç‚¹æ·»åŠ åˆ°åŒæ­¥é˜Ÿåˆ—æ—¶è¢«è®¾ç½®ï¼ˆå°¾éƒ¨æ·»åŠ ï¼‰ */\n    volatile Node prev;\n\n    /** åç»§èŠ‚ç‚¹ */\n    volatile Node next;\n\n    /** ç­‰å¾…é˜Ÿåˆ—ä¸­çš„åç»­èŠ‚ç‚¹ã€‚å¦‚æœå½“å‰èŠ‚ç‚¹æ˜¯å…±äº«çš„ï¼Œé‚£ä¹ˆå­—æ®µå°†æ˜¯ä¸€ä¸ª SHARED å¸¸é‡ï¼Œä¹Ÿå°±æ˜¯è¯´èŠ‚ç‚¹ç±»å‹ï¼ˆç‹¬å å’Œå…±äº«ï¼‰å’Œç­‰å¾…é˜Ÿåˆ—ä¸­çš„åç»­èŠ‚ç‚¹å…±ç”¨åŒä¸€ä¸ªå­—æ®µ */\n    Node nextWaiter;\n    \n    /** è·å–åŒæ­¥çŠ¶æ€çš„çº¿ç¨‹ */\n    volatile Thread thread;\n\n    final boolean isShared() {\n        return nextWaiter == SHARED;\n    }\n\n    final Node predecessor() throws NullPointerException {\n        Node p = prev;\n        if (p == null)\n            throw new NullPointerException();\n        else\n            return p;\n    }\n\n    Node() { // Used to establish initial head or SHARED marker\n    }\n\n    Node(Thread thread, Node mode) { // Used by addWaiter\n        this.nextWaiter = mode;\n        this.thread = thread;\n    }\n\n    Node(Thread thread, int waitStatus) { // Used by Condition\n        this.waitStatus = waitStatus;\n        this.thread = thread;\n    }\n    \n}\n")])])]),v("ul",[v("li",[v("p",[v("code",[e._v("waitStatus")]),e._v(" å­—æ®µï¼Œç­‰å¾…çŠ¶æ€ï¼Œç”¨æ¥æ§åˆ¶çº¿ç¨‹çš„é˜»å¡å’Œå”¤é†’ï¼Œå¹¶ä¸”å¯ä»¥é¿å…ä¸å¿…è¦çš„è°ƒç”¨LockSupportçš„ "),v("code",[e._v("#park(...)")]),e._v(" å’Œ "),v("code",[e._v("#unpark(...)")]),e._v(" æ–¹æ³•ã€‚ã€‚ç›®å‰æœ‰ "),v("strong",[e._v("4")]),e._v(" ç§ï¼š"),v("code",[e._v("CANCELLED")]),e._v(" "),v("code",[e._v("SIGNAL")]),e._v(" "),v("code",[e._v("CONDITION")]),e._v(" "),v("code",[e._v("PROPAGATE")]),e._v(" ã€‚")]),e._v(" "),v("ul",[v("li",[e._v("å®é™…ä¸Šï¼Œæœ‰ç¬¬ "),v("strong",[e._v("5")]),e._v(" ç§ï¼Œ"),v("code",[e._v("INITAL")]),e._v(" ï¼Œå€¼ä¸º 0 ï¼Œåˆå§‹çŠ¶æ€ã€‚")]),e._v(" "),v("li",[e._v("ğŸ™‚ èƒ–å‹è¯·è®¤çœŸçœ‹ä¸‹æ¯ä¸ªç­‰å¾…çŠ¶æ€ä»£è¡¨çš„å«ä¹‰ï¼Œå®ƒä¸ä»…ä»…æŒ‡çš„æ˜¯ Node "),v("strong",[e._v("è‡ªå·±")]),e._v("çš„çº¿ç¨‹çš„ç­‰å¾…çŠ¶æ€ï¼Œä¹Ÿå¯ä»¥æ˜¯"),v("strong",[e._v("ä¸‹ä¸€ä¸ª")]),e._v("èŠ‚ç‚¹çš„çº¿ç¨‹çš„ç­‰å¾…çŠ¶æ€ã€‚")])])]),e._v(" "),v("li",[v("p",[e._v("CLH åŒæ­¥é˜Ÿåˆ—ï¼Œç»“æ„å›¾å¦‚ä¸‹ï¼š")]),e._v(" "),v("p",[v("img",{attrs:{src:"https://s2.loli.net/2023/12/26/6JwGpC4dzMUiOl3.png",alt:""}})]),e._v(" "),v("ul",[v("li",[v("code",[e._v("prev")]),e._v(" å’Œ "),v("code",[e._v("next")]),e._v(" å­—æ®µï¼Œæ˜¯ "),v("strong",[e._v("AbstractQueuedSynchronizer")]),e._v(" çš„å­—æ®µï¼Œåˆ†åˆ«æŒ‡å‘åŒæ­¥é˜Ÿåˆ—çš„å¤´å’Œå°¾ã€‚")]),e._v(" "),v("li",[v("code",[e._v("head")]),e._v(" å’Œ "),v("code",[e._v("tail")]),e._v(" å­—æ®µï¼Œåˆ†åˆ«æŒ‡å‘ Node èŠ‚ç‚¹çš„"),v("strong",[e._v("å‰ä¸€ä¸ª")]),e._v("å’Œ"),v("strong",[e._v("åä¸€ä¸ª")]),e._v(" Node èŠ‚ç‚¹ï¼Œä»è€Œå®ç°"),v("strong",[e._v("é“¾å¼åŒå‘é˜Ÿåˆ—")]),e._v("ã€‚å†é…åˆä¸Š "),v("code",[e._v("prev")]),e._v(" å’Œ "),v("code",[e._v("next")]),e._v(" å­—æ®µï¼Œå¿«é€Ÿå®šä½åˆ°åŒæ­¥é˜Ÿåˆ—çš„å¤´å°¾ã€‚")])])]),e._v(" "),v("li",[v("p",[v("code",[e._v("thread")]),e._v(" å­—æ®µï¼ŒNode èŠ‚ç‚¹å¯¹åº”çš„"),v("strong",[e._v("çº¿ç¨‹ Thread")]),e._v(" ã€‚")])]),e._v(" "),v("li",[v("p",[v("code",[e._v("nextWaiter")]),e._v(" å­—æ®µï¼ŒNode èŠ‚ç‚¹è·å–åŒæ­¥çŠ¶æ€çš„"),v("strong",[e._v("æ¨¡å‹( Mode )")]),e._v("ã€‚"),v("code",[e._v("#tryAcquire(int args)")]),e._v(" å’Œ "),v("code",[e._v("#tryAcquireShared(int args)")]),e._v(" æ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯"),v("strong",[e._v("ç‹¬å å¼")]),e._v("å’Œ"),v("strong",[e._v("å…±äº«å¼")]),e._v("è·å–åŒæ­¥çŠ¶æ€ã€‚åœ¨è·å–å¤±è´¥æ—¶ï¼Œå®ƒä»¬"),v("strong",[e._v("éƒ½ä¼š")]),e._v("è°ƒç”¨ "),v("code",[e._v("#addWaiter(Node mode)")]),e._v(" æ–¹æ³•"),v("strong",[e._v("å…¥é˜Ÿ")]),e._v("ã€‚è€Œ "),v("code",[e._v("nextWaiter")]),e._v(" å°±æ˜¯ç”¨æ¥è¡¨ç¤ºæ˜¯å“ªç§æ¨¡å¼ï¼š")]),e._v(" "),v("ul",[v("li",[v("code",[e._v("SHARED")]),e._v(" "),v("strong",[e._v("é™æ€ + ä¸å¯å˜")]),e._v("å­—æ®µï¼Œæšä¸¾"),v("strong",[e._v("å…±äº«")]),e._v("æ¨¡å¼ã€‚")]),e._v(" "),v("li",[v("code",[e._v("EXCLUSIVE")]),e._v(" "),v("strong",[e._v("é™æ€ + ä¸å¯å˜")]),e._v("å­—æ®µï¼Œæšä¸¾"),v("strong",[e._v("ç‹¬å ")]),e._v("æ¨¡å¼ã€‚")]),e._v(" "),v("li",[v("code",[e._v("#isShared()")]),e._v(" æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºå…±äº«å¼è·å–åŒæ­¥çŠ¶æ€ã€‚")])])]),e._v(" "),v("li",[v("p",[v("code",[e._v("#predecessor()")]),e._v(" æ–¹æ³•ï¼Œè·å¾— Node èŠ‚ç‚¹çš„"),v("strong",[e._v("å‰ä¸€ä¸ª")]),e._v(" Node èŠ‚ç‚¹ã€‚åœ¨æ–¹æ³•çš„å†…éƒ¨ï¼Œ"),v("code",[e._v("Node p = prev")]),e._v(" çš„æœ¬åœ°æ‹·è´ï¼Œæ˜¯ä¸ºäº†é¿å…å¹¶å‘æƒ…å†µä¸‹ï¼Œ"),v("code",[e._v("prev")]),e._v(" åˆ¤æ–­å®Œ "),v("code",[e._v("== null")]),e._v(" æ—¶ï¼Œæ°å¥½è¢«ä¿®æ”¹ï¼Œä»è€Œä¿è¯çº¿ç¨‹å®‰å…¨ã€‚")])]),e._v(" "),v("li",[v("p",[v("strong",[e._v("æ„é€ æ–¹æ³•")]),e._v("æœ‰ "),v("strong",[e._v("3")]),e._v(" ä¸ªï¼Œåˆ†åˆ«æ˜¯ï¼š")]),e._v(" "),v("ul",[v("li",[v("p",[v("code",[e._v("#Node()")]),e._v(" æ–¹æ³•ï¼šç”¨äº "),v("code",[e._v("SHARED")]),e._v(" çš„åˆ›å»ºã€‚")])]),e._v(" "),v("li",[v("div",{staticClass:"language- extra-class"},[v("pre",{pre:!0,attrs:{class:"language-text"}},[v("code",[e._v("#Node(Thread thread, Node mode)\n")])])]),v("p",[e._v("æ–¹æ³•ï¼šç”¨äº")]),e._v(" "),v("div",{staticClass:"language- extra-class"},[v("pre",{pre:!0,attrs:{class:"language-text"}},[v("code",[e._v("#addWaiter(Node mode)\n")])])]),v("p",[e._v("æ–¹æ³•ã€‚")]),e._v(" "),v("ul",[v("li",[e._v("ä» "),v("code",[e._v("mode")]),e._v(" æ–¹æ³•å‚æ•°ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹å‡ºå®ƒä»£è¡¨è·å–åŒæ­¥çŠ¶æ€çš„"),v("strong",[e._v("æ¨¡å¼")]),e._v("ã€‚")]),e._v(" "),v("li",[e._v("åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°è¿™ä¸ªæ„é€ æ–¹æ³•çš„ä½¿ç”¨ã€‚")])])]),e._v(" "),v("li",[v("div",{staticClass:"language- extra-class"},[v("pre",{pre:!0,attrs:{class:"language-text"}},[v("code",[e._v("#Node(Thread thread, int waitStatus)\n")])])]),v("p",[e._v("æ–¹æ³•ï¼Œç”¨äº")]),e._v(" "),v("div",{staticClass:"language- extra-class"},[v("pre",{pre:!0,attrs:{class:"language-text"}},[v("code",[e._v("#addConditionWaiter()\n")])])]),v("p",[e._v("æ–¹æ³•ã€‚")]),e._v(" "),v("ul",[v("li",[e._v("åœ¨æœ¬æ–‡ä¸­ï¼Œä¸ä¼šä½¿ç”¨ï¼Œæ‰€ä»¥è§£é‡Šæš‚æ—¶çœç•¥ã€‚")])])])])])]),e._v(" "),v("h1",{attrs:{id:"_3-å…¥åˆ—"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_3-å…¥åˆ—"}},[e._v("#")]),e._v(" 3. å…¥åˆ—")]),e._v(" "),v("p",[e._v("å­¦äº†æ•°æ®ç»“æ„çš„æˆ‘ä»¬ï¼ŒCLH é˜Ÿåˆ—å…¥åˆ—æ˜¯å†ç®€å•ä¸è¿‡äº†ï¼š")]),e._v(" "),v("ul",[v("li",[v("code",[e._v("tail")]),e._v(" æŒ‡å‘æ–°èŠ‚ç‚¹ã€‚")]),e._v(" "),v("li",[e._v("æ–°èŠ‚ç‚¹çš„ "),v("code",[e._v("prev")]),e._v(" æŒ‡å‘å½“å‰æœ€åçš„èŠ‚ç‚¹ã€‚")]),e._v(" "),v("li",[e._v("å½“å‰æœ€åä¸€ä¸ªèŠ‚ç‚¹çš„ "),v("code",[e._v("next")]),e._v(" æŒ‡å‘å½“å‰èŠ‚ç‚¹ã€‚")])]),e._v(" "),v("p",[e._v("è¿‡ç¨‹å›¾å¦‚ä¸‹ï¼š")]),e._v(" "),v("p",[v("img",{attrs:{src:"https://s2.loli.net/2023/12/26/n8QIioUfCR4SPBc.png",alt:""}})]),e._v(" "),v("p",[e._v("ä½†æ˜¯ï¼Œå®é™…ä¸Šï¼Œå…¥é˜Ÿé€»è¾‘å®ç°çš„ "),v("code",[e._v("#addWaiter(Node)")]),e._v(" æ–¹æ³•ï¼Œéœ€è¦è€ƒè™‘"),v("strong",[e._v("å¹¶å‘")]),e._v("çš„æƒ…å†µã€‚å®ƒé€šè¿‡ "),v("strong",[e._v("CAS")]),e._v(" çš„æ–¹å¼ï¼Œæ¥ä¿è¯æ­£ç¡®çš„æ·»åŠ  Node ã€‚ä»£ç å¦‚ä¸‹ï¼š")]),e._v(" "),v("div",{staticClass:"language- extra-class"},[v("pre",{pre:!0,attrs:{class:"language-text"}},[v("code",[e._v(" 1: private Node addWaiter(Node mode) {\n 2:     // æ–°å»ºèŠ‚ç‚¹\n 3:     Node node = new Node(Thread.currentThread(), mode);\n 4:     // è®°å½•åŸå°¾èŠ‚ç‚¹\n 5:     Node pred = tail;\n 6:     // å¿«é€Ÿå°è¯•ï¼Œæ·»åŠ æ–°èŠ‚ç‚¹ä¸ºå°¾èŠ‚ç‚¹\n 7:     if (pred != null) {\n 8:         // è®¾ç½®æ–° Node èŠ‚ç‚¹çš„å°¾èŠ‚ç‚¹ä¸ºåŸå°¾èŠ‚ç‚¹\n 9:         node.prev = pred;\n10:         // CAS è®¾ç½®æ–°çš„å°¾èŠ‚ç‚¹\n11:         if (compareAndSetTail(pred, node)) {\n12:             // æˆåŠŸï¼ŒåŸå°¾èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸ºæ–°èŠ‚ç‚¹\n13:             pred.next = node;\n14:             return node;\n15:         }\n16:     }\n17:     // å¤±è´¥ï¼Œå¤šæ¬¡å°è¯•ï¼Œç›´åˆ°æˆåŠŸ\n18:     enq(node);\n19:     return node;\n20: }\n")])])]),v("ul",[v("li",[v("p",[e._v("ç¬¬ 3 è¡Œï¼šåˆ›å»ºæ–°èŠ‚ç‚¹ "),v("code",[e._v("node")]),e._v(" ã€‚åœ¨åˆ›å»ºçš„æ„é€ æ–¹æ³•ï¼Œ"),v("code",[e._v("mode")]),e._v(" æ–¹æ³•å‚æ•°ï¼Œä¼ é€’è·å–åŒæ­¥çŠ¶æ€çš„æ¨¡å¼ã€‚")])]),e._v(" "),v("li",[v("p",[e._v("ç¬¬ 5 è¡Œï¼šè®°å½•"),v("strong",[e._v("åŸ")]),e._v("å°¾èŠ‚ç‚¹ "),v("code",[e._v("tail")]),e._v(" ã€‚")])]),e._v(" "),v("li",[v("p",[e._v("åœ¨ä¸‹é¢çš„ä»£ç ï¼Œä¼šåˆ†æˆ "),v("strong",[e._v("2")]),e._v(" éƒ¨åˆ†ï¼š")]),e._v(" "),v("ul",[v("li",[e._v("ç¬¬ 6 è‡³ 16 è¡Œï¼š"),v("strong",[e._v("å¿«é€Ÿ")]),e._v("å°è¯•ï¼Œæ·»åŠ æ–°èŠ‚ç‚¹ä¸ºå°¾èŠ‚ç‚¹ã€‚")]),e._v(" "),v("li",[e._v("ç¬¬ 18 è¡Œï¼šæ·»åŠ å¤±è´¥ï¼Œ"),v("strong",[e._v("å¤šæ¬¡")]),e._v("å°è¯•ï¼Œç›´åˆ°æˆåŠŸæ·»åŠ ã€‚")])])]),e._v(" "),v("li",[v("p",[e._v("========== ç¬¬ "),v("strong",[e._v("1")]),e._v(" éƒ¨åˆ† ==========")])]),e._v(" "),v("li",[v("p",[e._v("ç¬¬ 7 è¡Œï¼šå½“"),v("strong",[e._v("åŸ")]),e._v("å°¾èŠ‚ç‚¹éç©ºï¼Œæ‰æ‰§è¡Œ"),v("strong",[e._v("å¿«é€Ÿ")]),e._v("å°è¯•çš„é€»è¾‘ã€‚åœ¨ä¸‹é¢çš„ "),v("code",[e._v("#enq(Node node)")]),e._v(" æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°ï¼Œ"),v("strong",[e._v("é¦–")]),e._v("èŠ‚ç‚¹æœªåˆå§‹åŒ–çš„æ—¶ï¼Œ"),v("code",[e._v("head")]),e._v(" å’Œ "),v("code",[e._v("tail")]),e._v(" éƒ½ä¸ºç©ºã€‚")])]),e._v(" "),v("li",[v("p",[e._v("ç¬¬ 9 è¡Œï¼šè®¾ç½®"),v("strong",[e._v("æ–°")]),e._v("èŠ‚ç‚¹çš„"),v("strong",[e._v("å°¾")]),e._v("èŠ‚ç‚¹ä¸º"),v("strong",[e._v("åŸ")]),e._v("å°¾èŠ‚ç‚¹ã€‚")])]),e._v(" "),v("li",[v("p",[e._v("ç¬¬ 11 è¡Œï¼šè°ƒç”¨ "),v("code",[e._v("#compareAndSetTail(Node expect, Node update)")]),e._v(" æ–¹æ³•ï¼Œä½¿ç”¨ "),v("strong",[e._v("Unsafe")]),e._v(" æ¥ "),v("strong",[e._v("CAS")]),e._v(" è®¾ç½®"),v("strong",[e._v("å°¾")]),e._v("èŠ‚ç‚¹ "),v("code",[e._v("tail")]),e._v(" ä¸º"),v("strong",[e._v("æ–°")]),e._v("èŠ‚ç‚¹ã€‚ä»£ç å¦‚ä¸‹ï¼š")]),e._v(" "),v("div",{staticClass:"language- extra-class"},[v("pre",{pre:!0,attrs:{class:"language-text"}},[v("code",[e._v('private static final Unsafe unsafe = Unsafe.getUnsafe();\n\nprivate static final long tailOffset = unsafe.objectFieldOffset (AbstractQueuedSynchronizer.class.getDeclaredField("tail"));  // è¿™å—ä»£ç ï¼Œå®é™…åœ¨ static ä»£ç å—ï¼Œæ­¤å¤„ä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œåšäº†ç®€åŒ–ã€‚\n\nprivate final boolean compareAndSetTail(Node expect, Node update) {\n    return unsafe.compareAndSwapObject(this, tailOffset, expect, update);\n}\n')])])])]),e._v(" "),v("li",[v("p",[e._v("ç¬¬ 13 è¡Œï¼šæ·»åŠ "),v("strong",[e._v("æˆåŠŸ")]),e._v("ï¼Œæœ€ç»ˆï¼Œå°†"),v("strong",[e._v("åŸ")]),e._v("å°¾èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸º"),v("strong",[e._v("æ–°")]),e._v("èŠ‚ç‚¹ã€‚")])]),e._v(" "),v("li",[v("p",[e._v("ç¬¬ 14 è¡Œï¼šè¿”å›"),v("strong",[e._v("æ–°")]),e._v("èŠ‚ç‚¹ã€‚")])]),e._v(" "),v("li",[v("p",[e._v("å¦‚æœæ·»åŠ "),v("strong",[e._v("å¤±è´¥")]),e._v("ï¼Œå› ä¸ºå­˜åœ¨å¤šçº¿ç¨‹å¹¶å‘çš„æƒ…å†µï¼Œæ­¤æ—¶éœ€è¦æ‰§è¡Œã€ç¬¬ 18 è¡Œã€‘çš„ä»£ç ã€‚")])]),e._v(" "),v("li",[v("p",[e._v("========== ç¬¬ "),v("strong",[e._v("2")]),e._v(" éƒ¨åˆ† ==========")])]),e._v(" "),v("li",[v("p",[e._v("è°ƒç”¨ "),v("code",[e._v("#enq(Node node)")]),e._v(" æ–¹æ³•ï¼Œ"),v("strong",[e._v("å¤šæ¬¡")]),e._v("å°è¯•ï¼Œç›´åˆ°æˆåŠŸæ·»åŠ ã€‚ä»£ç å¦‚ä¸‹ï¼š")]),e._v(" "),v("div",{staticClass:"language- extra-class"},[v("pre",{pre:!0,attrs:{class:"language-text"}},[v("code",[e._v(" 1: private Node enq(final Node node) {\n 2:     // å¤šæ¬¡å°è¯•ï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢\n 3:     for (;;) {\n 4:         // è®°å½•åŸå°¾èŠ‚ç‚¹\n 5:         Node t = tail;\n 6:         // åŸå°¾èŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œåˆ›å»ºé¦–å°¾èŠ‚ç‚¹éƒ½ä¸º new Node()\n 7:         if (t == null) {\n 8:             if (compareAndSetHead(new Node()))\n 9:                 tail = head;\n10:         // åŸå°¾èŠ‚ç‚¹å­˜åœ¨ï¼Œæ·»åŠ æ–°èŠ‚ç‚¹ä¸ºå°¾èŠ‚ç‚¹\n11:         } else {\n12:             //è®¾ç½®ä¸ºå°¾èŠ‚ç‚¹\n13:             node.prev = t;\n14:             // CAS è®¾ç½®æ–°çš„å°¾èŠ‚ç‚¹\n15:             if (compareAndSetTail(t, node)) {\n16:                 // æˆåŠŸï¼ŒåŸå°¾èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸ºæ–°èŠ‚ç‚¹\n17:                 t.next = node;\n18:                 return t;\n19:             }\n20:         }\n21:     }\n22: }\n")])])]),v("ul",[v("li",[v("p",[e._v("ç¬¬ 3 è¡Œï¼šâ€œ"),v("strong",[e._v("æ­»")]),e._v("â€å¾ªç¯ï¼Œå¤šæ¬¡å°è¯•ï¼Œç›´åˆ°æˆåŠŸæ·»åŠ "),v("strong",[e._v("ä¸ºæ­¢")]),e._v("ã€ç¬¬ 18 è¡Œã€‘ã€‚")])]),e._v(" "),v("li",[v("p",[e._v("ç¬¬ 5 è¡Œï¼šè®°å½•åŸå°¾èŠ‚ç‚¹ "),v("code",[e._v("t")]),e._v(" ã€‚ğŸ™‚ å’Œ "),v("code",[e._v("#addWaiter(Node node)")]),e._v(" æ–¹æ³•çš„ã€ç¬¬ 5 è¡Œã€‘ç›¸åŒã€‚")])]),e._v(" "),v("li",[v("p",[e._v("ç¬¬ 10 è‡³ 19 è¡Œï¼šåŸå°¾èŠ‚ç‚¹å­˜åœ¨ï¼Œæ·»åŠ æ–°èŠ‚ç‚¹ä¸ºå°¾èŠ‚ç‚¹ã€‚ğŸ™‚ å’Œ "),v("code",[e._v("#addWaiter(Node node)")]),e._v(" æ–¹æ³•çš„ã€ç¬¬ 7 è‡³ 16 è¡Œã€‘ç›¸åŒã€‚")])]),e._v(" "),v("li",[v("p",[e._v("ç¬¬ 6 è‡³ 9 è¡Œï¼šåŸå°¾èŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œåˆ›å»º"),v("strong",[e._v("é¦–å°¾")]),e._v("èŠ‚ç‚¹éƒ½ä¸º "),v("strong",[e._v("new Node()")]),e._v(" ã€‚"),v("strong",[e._v("æ³¨æ„")]),e._v("ï¼Œæ­¤æ—¶ä¿®æ”¹çš„"),v("strong",[e._v("é¦–å°¾")]),e._v("èŠ‚ç‚¹æ˜¯é‡æ–°åˆ›å»º( "),v("code",[e._v("new Node()")]),e._v(" )çš„ï¼Œè€Œä¸æ˜¯"),v("strong",[e._v("æ–°èŠ‚ç‚¹")]),e._v("ï¼")]),e._v(" "),v("ul",[v("li",[e._v("è¿™é‡Œï¼Œç¬”è€…çš„ç†è§£æ˜¯ï¼Œé€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œåˆå§‹åŒ–å¥½åŒæ­¥é˜Ÿåˆ—çš„"),v("strong",[e._v("é¦–å°¾")]),e._v("ã€‚å¦å¤–ï¼Œåœ¨ AbstractQueuedSynchronizer çš„è®¾è®¡ä¸­ï¼Œ"),v("code",[e._v("head")]),e._v(" å­—æ®µï¼Œæ˜¯ä¸€ä¸ªâ€œå ä½èŠ‚ç‚¹â€(æš‚æ—¶æ²¡æƒ³åˆ°ç‰¹åˆ«å¥½çš„æ¯”å–»)ï¼Œä»£è¡¨"),v("strong",[e._v("æœ€åä¸€ä¸ª")]),e._v("è·å¾—åˆ°åŒæ­¥çŠ¶æ€çš„èŠ‚ç‚¹(çº¿ç¨‹)ï¼Œå®é™…å®ƒå·²ç»"),v("strong",[e._v("å‡ºåˆ—")]),e._v("ï¼Œæ‰€ä»¥å®ƒçš„ "),v("code",[e._v("Node.next")]),e._v(" æ‰æ˜¯"),v("strong",[e._v("çœŸæ­£")]),e._v("çš„é˜Ÿé¦–ã€‚å½“ç„¶ï¼ŒåŒæ­¥é˜Ÿåˆ—çš„åˆå§‹æ—¶ï¼Œ"),v("code",[e._v("new Node()")]),e._v(" ä¹Ÿæ˜¯æ»¡è¶³è¿™ä¸ªæ¡ä»¶ï¼Œå› ä¸ºæœ‰"),v("strong",[e._v("æ–°çš„")]),e._v(" Node è¿›é˜Ÿåˆ—ï¼Œ"),v("strong",[e._v("ç›®å‰å°±å·²ç»æœ‰çº¿ç¨‹è·å¾—åˆ°åŒæ­¥çŠ¶æ€")]),e._v("ã€‚")]),e._v(" "),v("li",[v("code",[e._v("#compareAndSetHead(Node update)")]),e._v(" æ–¹æ³•ï¼Œä½¿ç”¨ Unsafe æ¥ CAS è®¾ç½®å°¾èŠ‚ç‚¹ "),v("code",[e._v("head")]),e._v(" ä¸ºæ–°èŠ‚ç‚¹ã€‚ä»£ç å¦‚ä¸‹ï¼š")])]),e._v(" "),v("p",[e._v("private static final Unsafe unsafe = Unsafe.getUnsafe();")]),e._v(" "),v("p",[e._v('private static final long headOffset = unsafe.objectFieldOffset (AbstractQueuedSynchronizer.class.getDeclaredField("head"));  // è¿™å—ä»£ç ï¼Œå®é™…åœ¨ static ä»£ç å—ï¼Œæ­¤å¤„ä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œåšäº†ç®€åŒ–ã€‚')]),e._v(" "),v("p",[e._v("private final boolean compareAndSetHead(Node update) {\nreturn unsafe.compareAndSwapObject(this, headOffset, null, update);\n}")]),e._v(" "),v("ul",[v("li",[v("strong",[e._v("æ³¨æ„")]),e._v("ï¼Œç¬¬ä¸‰ä¸ªæ–¹æ³•å‚æ•°ä¸º "),v("code",[e._v("null")]),e._v(" ï¼Œä»£è¡¨éœ€è¦åŸ "),v("code",[e._v("head")]),e._v(" ä¸ºç©ºæ‰å¯ä»¥è®¾ç½®ã€‚ğŸ™‚ å’Œ "),v("code",[e._v("#compareAndSetTail(Node expect, Node update)")]),e._v(" æ–¹æ³•ï¼Œç±»ä¼¼ã€‚")])])])])])]),e._v(" "),v("h1",{attrs:{id:"_4-å‡ºåˆ—"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_4-å‡ºåˆ—"}},[e._v("#")]),e._v(" 4. å‡ºåˆ—")]),e._v(" "),v("h1",{attrs:{id:"_4-å‡ºåˆ—-2"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_4-å‡ºåˆ—-2"}},[e._v("#")]),e._v(" 4. å‡ºåˆ—")]),e._v(" "),v("p",[e._v("CLH åŒæ­¥é˜Ÿåˆ—éµå¾ª FIFOï¼Œé¦–èŠ‚ç‚¹çš„çº¿ç¨‹é‡Šæ”¾åŒæ­¥çŠ¶æ€åï¼Œå°†ä¼šå”¤é†’å®ƒçš„"),v("strong",[e._v("ä¸‹ä¸€ä¸ª")]),e._v("èŠ‚ç‚¹ï¼ˆ"),v("code",[e._v("Node.next")]),e._v("ï¼‰ã€‚è€Œåç»§èŠ‚ç‚¹å°†ä¼šåœ¨è·å–åŒæ­¥çŠ¶æ€æˆåŠŸæ—¶ï¼Œå°†è‡ªå·±è®¾ç½®ä¸ºé¦–èŠ‚ç‚¹( "),v("code",[e._v("head")]),e._v(" )ã€‚")]),e._v(" "),v("p",[e._v("è¿™ä¸ªè¿‡ç¨‹éå¸¸ç®€å•ï¼Œ"),v("code",[e._v("head")]),e._v(" æ‰§è¡Œè¯¥èŠ‚ç‚¹å¹¶æ–­å¼€åŸé¦–èŠ‚ç‚¹çš„ "),v("code",[e._v("next")]),e._v(" å’Œå½“å‰èŠ‚ç‚¹çš„ "),v("code",[e._v("prev")]),e._v(" å³å¯ã€‚æ³¨æ„ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹æ˜¯"),v("strong",[e._v("ä¸éœ€è¦ä½¿ç”¨ CAS æ¥ä¿è¯")]),e._v("çš„ï¼Œå› ä¸º"),v("strong",[e._v("åªæœ‰ä¸€ä¸ª")]),e._v("çº¿ç¨‹ï¼Œèƒ½å¤ŸæˆåŠŸè·å–åˆ°åŒæ­¥çŠ¶æ€ã€‚")]),e._v(" "),v("p",[e._v("è¿‡ç¨‹å›¾å¦‚ä¸‹ï¼š")]),e._v(" "),v("p",[v("img",{attrs:{src:"https://s2.loli.net/2023/12/26/3q9hZGHoEDmVBAT.png",alt:""}})]),e._v(" "),v("p",[v("code",[e._v("#setHead(Node node)")]),e._v(" æ–¹æ³•ï¼Œå®ç°ä¸Šè¿°çš„"),v("strong",[e._v("å‡ºåˆ—")]),e._v("é€»è¾‘ã€‚ä»£ç å¦‚ä¸‹ï¼š")]),e._v(" "),v("div",{staticClass:"language- extra-class"},[v("pre",{pre:!0,attrs:{class:"language-text"}},[v("code",[e._v("private void setHead(Node node) {\n    head = node;\n    node.thread = null;\n    node.prev = null;\n}\n")])])]),v("blockquote",[v("p",[e._v("https://www.iocoder.cn/JUC/sike/aqs-1-clh/")])])])}),[],!1,null,null,null);v.default=n.exports}}]);