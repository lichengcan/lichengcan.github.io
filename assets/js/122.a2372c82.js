(window.webpackJsonp=window.webpackJsonp||[]).push([[122],{541:function(e,r,n){"use strict";n.r(r);var a=n(2),t=Object(a.a)({},(function(){var e=this,r=e._self._c;return r("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[r("blockquote",[r("p",[e._v("转载："),r("a",{attrs:{href:"https://www.iocoder.cn/Spring-Boot/ActiveMQ/?self",target:"_blank",rel:"noopener noreferrer"}},[e._v("https://www.iocoder.cn/Spring-Boot/ActiveMQ/?self"),r("OutboundLink")],1)])]),e._v(" "),r("h1",{attrs:{id:"_1-概述"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_1-概述"}},[e._v("#")]),e._v(" 1. 概述")]),e._v(" "),r("p",[e._v("如果胖友还没了解过分布式消息队列 "),r("a",{attrs:{href:"https://activemq.apache.org/",target:"_blank",rel:"noopener noreferrer"}},[e._v("ActiveMQ"),r("OutboundLink")],1),e._v(" ，建议先阅读下艿艿写的 "),r("a",{attrs:{href:"http://www.iocoder.cn/ActiveMQ/install/?self",target:"_blank",rel:"noopener noreferrer"}},[e._v("《芋道 ActiveMQ 极简入门》"),r("OutboundLink")],1),e._v(" 文章。虽然这篇文章标题是安装部署，实际可以理解成《一文带你快速入门 ActiveMQ》，哈哈哈。")]),e._v(" "),r("p",[e._v("考虑这是 ActiveMQ 如何在 Spring Boot 整合与使用的文章，所以还是简单介绍下 ActiveMQ 是什么？")]),e._v(" "),r("blockquote",[r("p",[e._v("FROM "),r("a",{attrs:{href:"https://www.oschina.net/p/activemq",target:"_blank",rel:"noopener noreferrer"}},[e._v("《JMS 消息服务器 ActiveMQ》"),r("OutboundLink")],1)]),e._v(" "),r("p",[e._v("ActiveMQ 是 Apache 出品，最流行的，能力强劲的开源消息总线。")]),e._v(" "),r("p",[e._v("ActiveMQ 是一个完全支持 JMS1.1 和 J2EE1.4 规范的 JMS Provider 实现，尽管 JMS 规范出台已经是很久的事情了,但是 JMS 在当今的 J2EE 应用中间仍然扮演着特殊的地位。")]),e._v(" "),r("p",[e._v("主要特点：")]),e._v(" "),r("ol",[r("li",[e._v("多种语言和协议编写客户端。语言: Java, C, C++, C#, Ruby, Perl, Python, PHP。应用协议: OpenWire,Stomp REST,WS Notification,XMPP,AMQP")]),e._v(" "),r("li",[e._v("完全支持JMS1.1 和 J2EE1.4 规范 (持久化,XA消息,事务)")]),e._v(" "),r("li",[e._v("对 Spring 的支持,ActiveMQ 可以很容易内嵌到使用 Spring 的系统里面去,而且也支持 Spring2.0 的特性")]),e._v(" "),r("li",[e._v("通过了常见 J2EE 服务器(如 Geronimo,JBoss 4, GlassFish,WebLogic)的测试,其中通过 JCA 1.5 resource adaptors 的配置,可以让ActiveMQ可以自动的部署到任何兼容J2EE 1.4 商业服务器上")]),e._v(" "),r("li",[e._v("支持多种传送协议:in-VM,TCP,SSL,NIO,UDP,JGroups,JXTA")]),e._v(" "),r("li",[e._v("支持通过 JDBC 和 journal 提供高速的消息持久化")]),e._v(" "),r("li",[e._v("从设计上保证了高性能的集群,客户端-服务器,点对点")]),e._v(" "),r("li",[e._v("支持 Ajax")]),e._v(" "),r("li",[e._v("支持与 Axis 的整合")]),e._v(" "),r("li",[e._v("可以很容易得调用内嵌 JMS provider,进行测试")])])]),e._v(" "),r("p",[e._v("在本文中，我们会比 "),r("a",{attrs:{href:"http://www.iocoder.cn/ActiveMQ/install/?self",target:"_blank",rel:"noopener noreferrer"}},[e._v("《芋道 ActiveMQ 极简入门》"),r("OutboundLink")],1),e._v(" 提供更多的生产者 Producer 和消费者 Consumer 的使用示例。例如说：")]),e._v(" "),r("ul",[r("li",[e._v("Producer 同步与异步发送消息的方式。")]),e._v(" "),r("li",[e._v("Producer 发送"),r("strong",[e._v("顺序")]),e._v("消息，Consumer "),r("strong",[e._v("顺序")]),e._v("消费消息。")]),e._v(" "),r("li",[e._v("Producer 发送"),r("strong",[e._v("定时")]),e._v("消息。")]),e._v(" "),r("li",[e._v("Producer 发送"),r("strong",[e._v("事务")]),e._v("消息。TODO")]),e._v(" "),r("li",[e._v("Consumer "),r("strong",[e._v("广播")]),e._v("和"),r("strong",[e._v("集群")]),e._v("消费消息。")])]),e._v(" "),r("h1",{attrs:{id:"_2-spring-jms"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_2-spring-jms"}},[e._v("#")]),e._v(" 2. Spring-JMS")]),e._v(" "),r("p",[e._v("在 Spring 体系中，提供了 "),r("a",{attrs:{href:"https://github.com/spring-projects/spring-framework/tree/master/spring-jms",target:"_blank",rel:"noopener noreferrer"}},[e._v("Spring-JMS"),r("OutboundLink")],1),e._v(" 组件，实现对 "),r("a",{attrs:{href:"https://mvnrepository.com/artifact/javax.jms/javax.jms-api",target:"_blank",rel:"noopener noreferrer"}},[e._v("JMS"),r("OutboundLink")],1),e._v(" 规范的集成。我们来看看 Spring 文档对 Spring JMS 的描述：")]),e._v(" "),r("blockquote",[r("p",[e._v("FROM "),r("a",{attrs:{href:"https://docs.spring.io/spring-framework/docs/current/spring-framework-reference/integration.html#jms",target:"_blank",rel:"noopener noreferrer"}},[e._v("《Spring 文档 —— JMS (Java Message Service)》"),r("OutboundLink")],1)]),e._v(" "),r("p",[e._v("Spring provides a JMS integration framework that simplifies the use of the JMS API in much the same way as Spring’s integration does for the JDBC API.\nSpring 提供了一个 JMS 的集成框架，简化了 JMS API 的使用，就像 Spring 对 JDBC API 的集成一样。")]),e._v(" "),r("p",[e._v("JMS can be roughly divided into two areas of functionality, namely the production and consumption of messages.")]),e._v(" "),r("ul",[r("li",[e._v("The "),r("a",{attrs:{href:"https://github.com/spring-projects/spring-framework/blob/master/spring-jms/src/main/java/org/springframework/jms/core/JmsTemplate.java",target:"_blank",rel:"noopener noreferrer"}},[e._v("JmsTemplate"),r("OutboundLink")],1),e._v(" class is used for message production and synchronous message reception.")]),e._v(" "),r("li",[e._v("For asynchronous reception similar to Java EE’s message-driven bean style, Spring provides a number of message-listener containers that you can use to create Message-Driven POJOs (MDPs). Spring also provides a declarative way to create message listeners.")])]),e._v(" "),r("p",[e._v("JMS 可以大致分为两块功能，即消息的发送和消费。")]),e._v(" "),r("ul",[r("li",[e._v("JmsTemplate 类，用于消息的发送和消息的同步接收。")]),e._v(" "),r("li",[e._v("对于类似 Java EE 的消息驱动 Bean 形式的异步接收，Spring 提供了大量用于创建消息驱动 POJOs（MDPs）的消息监听器。Spring 还提供了一种创建消息侦听器的"),r("strong",[e._v("声明式")]),e._v("方法。")])])]),e._v(" "),r("ul",[r("li",[e._v("英文跟艿艿一样不好的胖友，可以看看"),r("a",{attrs:{href:"https://my.oschina.net/landas/blog/858784",target:"_blank",rel:"noopener noreferrer"}},[e._v("《【译】Spring Framework Reference —— JMS 部分》"),r("OutboundLink")],1),e._v(" 。")]),e._v(" "),r("li",[e._v("因为 ActiveMQ 提供了对 JMS 规范的支持，自然 Spring-JMS 可以访问 ActiveMQ 消息队列，更加方便的实现消息的发送与消费。")])]),e._v(" "),r("p",[e._v("在 "),r("a",{attrs:{href:"https://spring.io/projects/spring-boot",target:"_blank",rel:"noopener noreferrer"}},[e._v("Spring-Boot"),r("OutboundLink")],1),e._v(" 项目中，提供了 ActiveMQ 的自动化配置，所以我们仅需引入 "),r("a",{attrs:{href:"https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-activemq",target:"_blank",rel:"noopener noreferrer"}},[r("code",[e._v("spring-boot-starter-activemq")]),r("OutboundLink")],1),e._v(" 依赖，即可愉快的使用。")]),e._v(" "),r("h1",{attrs:{id:"_3-快速入门"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_3-快速入门"}},[e._v("#")]),e._v(" 3. 快速入门")]),e._v(" "),r("blockquote",[r("p",[e._v("示例代码对应仓库："),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-32/lab-32-activemq-demo",target:"_blank",rel:"noopener noreferrer"}},[e._v("lab-32-activemq-demo"),r("OutboundLink")],1),e._v(" 。")])]),e._v(" "),r("p",[e._v("本小节，我们先来对 Spring-JMS 做一个快速入门，实现 Producer 同步与异步发送消息到 Queue 中，同时创建一个 Consumer 消费消息。")]),e._v(" "),r("p",[e._v("考虑到一个应用既可以使用生产者 Producer ，又可以使用消费者 Consumer ，所以示例就做成一个 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-32/lab-32-activemq-demo",target:"_blank",rel:"noopener noreferrer"}},[e._v("lab-32-activemq-demo"),r("OutboundLink")],1),e._v(" 项目。")]),e._v(" "),r("h2",{attrs:{id:"_3-1-引入依赖"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-引入依赖"}},[e._v("#")]),e._v(" 3.1 引入依赖")]),e._v(" "),r("p",[e._v("在 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-32/lab-32-activemq-demo/pom.xml",target:"_blank",rel:"noopener noreferrer"}},[r("code",[e._v("pom.xml")]),r("OutboundLink")],1),e._v(" 文件中，引入相关依赖。")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v('<?xml version="1.0" encoding="UTF-8"?>\n<project xmlns="http://maven.apache.org/POM/4.0.0"\n         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"\n         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">\n    <parent>\n        <groupId>org.springframework.boot</groupId>\n        <artifactId>spring-boot-starter-parent</artifactId>\n        <version>2.2.1.RELEASE</version>\n        <relativePath/> \x3c!-- lookup parent from repository --\x3e\n    </parent>\n    <modelVersion>4.0.0</modelVersion>\n\n    <artifactId>lab-32-activemq-demo</artifactId>\n\n    <dependencies>\n        \x3c!-- 实现对 ActiveMQ 的自动化配置 --\x3e\n        <dependency>\n            <groupId>org.springframework.boot</groupId>\n            <artifactId>spring-boot-starter-activemq</artifactId>\n        </dependency>\n\n        \x3c!-- 方便等会写单元测试 --\x3e\n        <dependency>\n            <groupId>org.springframework.boot</groupId>\n            <artifactId>spring-boot-starter-test</artifactId>\n            <scope>test</scope>\n        </dependency>\n    </dependencies>\n\n</project>\n')])])]),r("ul",[r("li",[e._v("具体每个依赖的作用，胖友自己认真看下艿艿添加的所有注释噢。")])]),e._v(" "),r("h2",{attrs:{id:"_3-2-应用配置文件"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-应用配置文件"}},[e._v("#")]),e._v(" 3.2 应用配置文件")]),e._v(" "),r("p",[e._v("在 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-32/lab-32-activemq-demo/src/main/resources",target:"_blank",rel:"noopener noreferrer"}},[r("code",[e._v("resources")]),r("OutboundLink")],1),e._v(" 目录下，创建 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-32/lab-32-activemq-demo/src/main/resources/application.yaml",target:"_blank",rel:"noopener noreferrer"}},[r("code",[e._v("application.yaml")]),r("OutboundLink")],1),e._v(" 配置文件。配置如下：")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("spring:\n  # ActiveMQ 配置项，对应 ActiveMQProperties 配置类\n  activemq:\n    broker-url: tcp://127.0.0.1:61616 # Activemq Broker 的地址\n    user: admin # 账号\n    password: admin # 密码\n    packages:\n      trust-all: true # 可信任的反序列化包\n")])])]),r("ul",[r("li",[e._v("在 "),r("code",[e._v("spring.activemq")]),e._v(" 配置项，设置 Kafka 的配置，对应 "),r("a",{attrs:{href:"https://github.com/spring-projects/spring-boot/blob/master/spring-boot-project/spring-boot-autoconfigure/src/main/java/org/springframework/boot/autoconfigure/jms/activemq/ActiveMQProperties.java",target:"_blank",rel:"noopener noreferrer"}},[e._v("ActiveMQProperties"),r("OutboundLink")],1),e._v(" 配置类。")]),e._v(" "),r("li",[e._v("Spring Boot 提供的 "),r("a",{attrs:{href:"https://github.com/spring-projects/spring-boot/blob/master/spring-boot-project/spring-boot-autoconfigure/src/main/java/org/springframework/boot/autoconfigure/jms/activemq/ActiveMQAutoConfiguration.java",target:"_blank",rel:"noopener noreferrer"}},[e._v("ActiveMQAutoConfiguration"),r("OutboundLink")],1),e._v(" 自动化配置类，实现 ActiveMQ 的自动配置，创建相应的 Producer 和 Consumer 。")]),e._v(" "),r("li",[r("code",[e._v("spring.activemq.packages.trust-all")]),e._v(" 配置项，配置可信赖所有的 "),r("code",[e._v("package")]),e._v(" 包。因为 ActiveMQ 在反序列化 POJO 的消息时，考虑到安全性，如果非可信赖的 Java 类，会抛出 "),r("code",[e._v('"This class is not trusted to be serialized"')]),e._v(" 的异常。😈 想要尝试下效果的胖友，可以选择去掉这个配置，很酸爽。")])]),e._v(" "),r("h2",{attrs:{id:"_3-3-application"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-application"}},[e._v("#")]),e._v(" 3.3 Application")]),e._v(" "),r("p",[e._v("创建 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-32/lab-32-activemq-demo/src/main/java/cn/iocoder/springboot/lab32/activemqdemo/Application.java",target:"_blank",rel:"noopener noreferrer"}},[r("code",[e._v("Application.java")]),r("OutboundLink")],1),e._v(" 类，配置 "),r("code",[e._v("@SpringBootApplication")]),e._v(" 注解即可。代码如下：")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("// Application.java\n\n@SpringBootApplication\n@EnableAsync // 开启异步\npublic class Application {\n\n    public static void main(String[] args) {\n        SpringApplication.run(Application.class, args);\n    }\n\n}\n")])])]),r("ul",[r("li",[e._v("我们额外添加了 "),r("code",[e._v("@EnableAsync")]),e._v(" 注解，因为我们稍后要使用 Spring 提供的异步调用的功能。不了解这块的胖友，可以看看艿艿写的 "),r("a",{attrs:{href:"http://www.iocoder.cn/Spring-Boot/Async-Job/?self",target:"_blank",rel:"noopener noreferrer"}},[e._v("《芋道 Spring Boot 异步任务入门》"),r("OutboundLink")],1),e._v(" 文章。")])]),e._v(" "),r("h2",{attrs:{id:"_3-4-demo01message"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-demo01message"}},[e._v("#")]),e._v(" 3.4 Demo01Message")]),e._v(" "),r("p",[e._v("在 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-32/lab-32-activemq-demo/src/main/java/cn/iocoder/springboot/lab32/activemqdemo/message",target:"_blank",rel:"noopener noreferrer"}},[r("code",[e._v("cn.iocoder.springboot.lab32.activemqdemo.message")]),r("OutboundLink")],1),e._v(" 包下，创建 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-32/lab-32-activemq-demo/src/main/java/cn/iocoder/springboot/lab32/activemqdemo/message/Demo01Message.java",target:"_blank",rel:"noopener noreferrer"}},[e._v("Demo01Message"),r("OutboundLink")],1),e._v(" 消息类，提供给当前示例使用。代码如下：")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v('// Demo01Message.java\n\npublic class Demo01Message implements Serializable {\n\n    public static final String QUEUE = "QUEUE_DEMO_01";\n\n    /**\n     * 编号\n     */\n    private Integer id;\n\n    // ... 省略 set/get/toString 方法\n\n}\n')])])]),r("ul",[r("li",[e._v("注意，要实现 Java Serializable 序列化接口。因为 JMS 规范要求 POJO 消息类，需要实现 Serializable 接口。")]),e._v(" "),r("li",[e._v("在消息类里，我们枚举了 Queue 的名字。")])]),e._v(" "),r("p",[e._v("我们无需中去 ActiveMQ 或者 Spring-JMS "),r("strong",[e._v("主动")]),e._v("声明这个 ActiveMQ Queue 。因为 Consumer 订阅该 Queue 时，会"),r("strong",[e._v("自动")]),e._v("进行创建。又或者 Producer 在发送消息到 Queue 中时，也会"),r("strong",[e._v("自动")]),e._v("进行创建。")]),e._v(" "),r("h2",{attrs:{id:"_3-5-demo01producer"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_3-5-demo01producer"}},[e._v("#")]),e._v(" 3.5 Demo01Producer")]),e._v(" "),r("p",[e._v("在 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-32/lab-32-activemq-demo/src/main/java/cn/iocoder/springboot/lab32/activemqdemo/producer",target:"_blank",rel:"noopener noreferrer"}},[r("code",[e._v("cn.iocoder.springboot.lab32.activemqdemo.producer")]),r("OutboundLink")],1),e._v(" 包下，创建 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-32/lab-32-activemq-demo/src/main/java/cn/iocoder/springboot/lab32/activemqdemo/producer/Demo01Producer.java",target:"_blank",rel:"noopener noreferrer"}},[e._v("Demo01Producer"),r("OutboundLink")],1),e._v(" 类，它会使用 Spring-JMS 封装提供的 JmsMessagingTemplate ，实现发送消息。代码如下：")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("// Demo01Producer.java\n\n@Component\npublic class Demo01Producer {\n\n    @Autowired\n    private JmsMessagingTemplate jmsTemplate;\n\n    public void syncSend(Integer id) {\n        // 创建 Demo01Message 消息\n        Demo01Message message = new Demo01Message();\n        message.setId(id);\n        // 同步发送消息\n        jmsTemplate.convertAndSend(Demo01Message.QUEUE, message);\n    }\n\n    @Async\n    public ListenableFuture<Void> asyncSend(Integer id) {\n        try {\n            // 发送消息\n            this.syncSend(id);\n            // 返回成功的 Future\n            return AsyncResult.forValue(null);\n        } catch (Throwable ex) {\n            // 返回异常的 Future\n            return AsyncResult.forExecutionException(ex);\n        }\n    }\n\n}\n")])])]),r("ul",[r("li",[r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("jmsTemplate\n")])])]),r("p",[e._v("属性，是")]),e._v(" "),r("p",[e._v("JmsMessagingTemplate")]),e._v(" "),r("p",[e._v("对象，而不是")]),e._v(" "),r("p",[e._v("JmsTemplate")]),e._v(" "),r("p",[e._v("。")]),e._v(" "),r("ul",[r("li",[e._v("JmsTemplate 是 JMS API 的封装，简化消息的发送与接收。")]),e._v(" "),r("li",[e._v("JmsMessagingTemplate 是将 JmsTemplate 集成到 "),r("a",{attrs:{href:"https://github.com/spring-projects/spring-framework/tree/master/spring-messaging/src/main/java/org/springframework/messaging",target:"_blank",rel:"noopener noreferrer"}},[e._v("Spring-Messaging"),r("OutboundLink")],1),e._v(" 体系中，其内部调用的还是 JmsTemplate 的方法。")])])]),e._v(" "),r("li",[r("p",[r("code",[e._v("#syncSend(Integer id)")]),e._v(" 方法，调用 JmsMessagingTemplate 的同步发送消息方法。")])]),e._v(" "),r("li",[r("p",[r("code",[e._v("#asyncSend(Integer id)")]),e._v(" 方法，通过 "),r("code",[e._v("@Async")]),e._v(" 注解，声明异步调用该方法，从而实现异步消息到 ActiveMQ 中。因为 JmsMessagingTemplate 并未像 "),r("a",{attrs:{href:"https://github.com/spring-projects/spring-kafka/blob/master/spring-kafka/src/main/java/org/springframework/kafka/core/KafkaTemplate.java",target:"_blank",rel:"noopener noreferrer"}},[e._v("KafkaTemplate"),r("OutboundLink")],1),e._v(" 或 "),r("a",{attrs:{href:"https://github.com/apache/rocketmq-spring/blob/master/rocketmq-spring-boot/src/main/java/org/apache/rocketmq/spring/core/RocketMQTemplate.java",target:"_blank",rel:"noopener noreferrer"}},[e._v("RocketMQTemplate"),r("OutboundLink")],1),e._v(" 直接提供了异步发送消息的方法，所以我们需要结合 Spring 异步调用来实现。")])])]),e._v(" "),r("h2",{attrs:{id:"_3-6-demo01consumer"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_3-6-demo01consumer"}},[e._v("#")]),e._v(" 3.6 Demo01Consumer")]),e._v(" "),r("p",[e._v("在 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-32/lab-32-activemq-demo/src/main/java/cn/iocoder/springboot/lab32/activemqdemo/consumer",target:"_blank",rel:"noopener noreferrer"}},[r("code",[e._v("cn.iocoder.springboot.lab32.activemqdemo.consumer")]),r("OutboundLink")],1),e._v(" 包下，创建 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-32/lab-32-activemq-demo/src/main/java/cn/iocoder/springboot/lab32/activemqdemo/consumer/Demo01Consumer.java",target:"_blank",rel:"noopener noreferrer"}},[e._v("Demo01Consumer"),r("OutboundLink")],1),e._v(" 类，消费消息。代码如下：")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v('// Demo01Consumer.java\n\n@Component\npublic class Demo01Consumer {\n\n    private Logger logger = LoggerFactory.getLogger(getClass());\n\n    @JmsListener(destination = Demo01Message.QUEUE)\n    public void onMessage(Demo01Message message) {\n        logger.info("[onMessage][线程编号:{} 消息内容：{}]", Thread.currentThread().getId(), message);\n    }\n\n//    @JmsListener(destination = Demo01Message.QUEUE)\n//    public void onMessage(javax.jms.Message message) {\n//        logger.info("[onMessage][线程编号:{} 消息内容：{}]", Thread.currentThread().getId(), message);\n//    }\n\n}\n')])])]),r("ul",[r("li",[e._v("在类上，添加了 "),r("code",[e._v("@Component")]),e._v(" 注解，保证其能被 Spring 作为一个 Bean 扫描到。")]),e._v(" "),r("li",[e._v("在方法上，添加了 "),r("a",{attrs:{href:"https://github.com/spring-projects/spring-framework/blob/master/spring-jms/src/main/java/org/springframework/jms/annotation/JmsListener.java",target:"_blank",rel:"noopener noreferrer"}},[r("code",[e._v("@JmsListener")]),r("OutboundLink")],1),e._v(" 注解，申明了处理消息的方法。同时，方法入参为消息的类型。这里，我们设置了"),r("a",{attrs:{href:"https://www.iocoder.cn/Spring-Boot/ActiveMQ/?self#",target:"_blank",rel:"noopener noreferrer"}},[e._v("「3.4 Demo01Message」"),r("OutboundLink")],1),e._v(" 。")]),e._v(" "),r("li",[e._v("如果我们想要获得消费消息的更多信息，例如说，消息编号、创建时间等等信息，则可以考虑使用艿艿"),r("strong",[e._v("注释掉的那段代码")]),e._v("，通过方法入参为 "),r("a",{attrs:{href:"https://github.com/javaee/javax.jms/blob/master/src/main/java/javax/jms/Message.java",target:"_blank",rel:"noopener noreferrer"}},[r("code",[e._v("javax.jms.Messagee")]),r("OutboundLink")],1),e._v(" 类型。不过绝大多数情况下，我们并不需要这么做。")])]),e._v(" "),r("h2",{attrs:{id:"_3-7-简单测试"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_3-7-简单测试"}},[e._v("#")]),e._v(" 3.7 简单测试")]),e._v(" "),r("p",[e._v("创建 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-32/lab-32-activemq-demo/src/test/java/cn/iocoder/springboot/lab32/activemqdemo/producer/Demo01ProducerTest.java",target:"_blank",rel:"noopener noreferrer"}},[e._v("Demo01ProducerTest"),r("OutboundLink")],1),e._v(" 测试类，编写单元测试方法，调用 Demo01Producer 两个发送消息的方式。代码如下：")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v('// Demo01ProducerTest.java\n\n@RunWith(SpringRunner.class)\n@SpringBootTest(classes = Application.class)\npublic class Demo01ProducerTest {\n\n    private Logger logger = LoggerFactory.getLogger(getClass());\n\n    @Autowired\n    private Demo01Producer producer;\n\n    @Test\n    public void testSyncSend() throws InterruptedException {\n        // 发送消息\n        int id = (int) (System.currentTimeMillis() / 1000);\n        producer.syncSend(id);\n        logger.info("[testSyncSend][发送编号：[{}] 发送成功]", id);\n\n        // 阻塞等待，保证消费\n        new CountDownLatch(1).await();\n    }\n\n    @Test\n    public void testAsyncSend() throws InterruptedException {\n        int id = (int) (System.currentTimeMillis() / 1000);\n        producer.asyncSend(id).addCallback(new ListenableFutureCallback<Void>() {\n\n            @Override\n            public void onFailure(Throwable e) {\n                logger.info("[testASyncSend][发送编号：[{}] 发送异常]]", id, e);\n            }\n\n            @Override\n            public void onSuccess(Void aVoid) {\n                logger.info("[testASyncSend][发送编号：[{}] 发送成功，发送成功]", id);\n            }\n\n        });\n        logger.info("[testASyncSend][发送编号：[{}] 调用完成]", id);\n\n        // 阻塞等待，保证消费\n        new CountDownLatch(1).await();\n    }\n\n}\n')])])]),r("ul",[r("li",[e._v("比较简单，胖友自己看下两个单元测试方法。")])]),e._v(" "),r("p",[e._v("我们来执行 "),r("code",[e._v("#testSyncSend()")]),e._v(" 方法，测试同步发送消息。控制台输出如下：")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("# Producer 同步发送消息成功。\n2019-12-15 00:19:18.736  INFO 87164 --- [           main] c.i.s.l.r.producer.Demo01ProducerTest    : [testSyncSend][发送编号：[1575908358] 发送成功]\n\n# Demo01Consumer 成功消费了该消息\n2019-12-15 00:19:18.751  INFO 87164 --- [ntContainer#0-1] c.i.s.l.r.consumer.Demo01Consumer        : [onMessage][线程编号:17 消息内容：Demo01Message{id=1575908358}]\n")])])]),r("ul",[r("li",[e._v("同步发送的消息，成功被消费。")])]),e._v(" "),r("p",[e._v("我们再来执行 "),r("code",[e._v("#tesSyncSendDefault()")]),e._v(" 方法，测试另一个同步发送消息。控制台输出如下：")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("# Producer 同步发送消息成功。\n2019-12-15 11:50:38.857  INFO 74430 --- [           main] c.i.s.l.a.producer.Demo01ProducerTest    : [testSyncSend][发送编号：[1576381838] 发送成功]\n\n# Demo01Consumer 成功消费了该消息\n2019-12-15 11:50:38.860  INFO 74430 --- [enerContainer-1] c.i.s.l.a.consumer.Demo01Consumer        : [onMessage][线程编号:18 消息内容：Demo01Message{id=1576381838}]\n")])])]),r("ul",[r("li",[e._v("同步发送的消息，成功也被消费。")])]),e._v(" "),r("p",[e._v("我们最后来执行 "),r("code",[e._v("#testAsyncSend()")]),e._v(" 方法，测试异步发送消息。控制台输出如下：")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("# Producer 异步发送消息的调用完成。\n2019-12-15 11:52:43.156  INFO 74582 --- [           main] c.i.s.l.a.producer.Demo01ProducerTest    : [testASyncSend][发送编号：[1576381963] 调用完成]\n\n# Producer 异步发送消息成功。【回调】\n2019-12-15 11:52:43.214  INFO 74582 --- [         task-1] c.i.s.l.a.producer.Demo01ProducerTest    : [testASyncSend][发送编号：[1576381963] 发送成功，发送成功]\n\n# Demo01Consumer 成功消费了该消息\n2019-12-15 11:52:43.218  INFO 74582 --- [enerContainer-1] c.i.s.l.a.consumer.Demo01Consumer        : [onMessage][线程编号:18 消息内容：Demo01Message{id=1576381963}]\n")])])]),r("ul",[r("li",[e._v("异步发送的消息，成功也被消费。")])]),e._v(" "),r("h1",{attrs:{id:"_4-消息模式"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_4-消息模式"}},[e._v("#")]),e._v(" 4. 消息模式")]),e._v(" "),r("blockquote",[r("p",[e._v("示例代码对应仓库："),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-32/lab-32-activemq-demo-message-model",target:"_blank",rel:"noopener noreferrer"}},[e._v("lab-32-activemq-demo-message-model"),r("OutboundLink")],1)])]),e._v(" "),r("p",[e._v("在 JMS 规范中，定义了两种消息模式：")]),e._v(" "),r("ul",[r("li",[e._v("点对点（point to point）：基于 Queue 队列的方式。")]),e._v(" "),r("li",[e._v("发布/订阅（publish/subscribe）：基于 Topic 主题的方式。")])]),e._v(" "),r("p",[e._v("具体的概念，艿艿就先不解释，胖友可以看看"),r("a",{attrs:{href:"http://www.iocoder.cn/Fight/There-are-two-modes-of-message-queuing-point-to-point-and-publish-subscription/?self",target:"_blank",rel:"noopener noreferrer"}},[e._v("《消息队列两种模式：点对点与发布订阅》"),r("OutboundLink")],1),e._v("文章。🙂 实际上，我们在"),r("a",{attrs:{href:"https://www.iocoder.cn/Spring-Boot/ActiveMQ/?self#",target:"_blank",rel:"noopener noreferrer"}},[e._v("「3. 快速入门」"),r("OutboundLink")],1),e._v("中，就采用的是点对点的消息模式。")]),e._v(" "),r("p",[e._v("如果胖友有使用过 RocketMQ 或者 Kafka 消息队列，可能比较习惯的叫法是：")]),e._v(" "),r("blockquote",[r("p",[r("strong",[e._v("集群消费（Clustering）")]),e._v("：对应「点对点」 集群消费模式下，相同 Consumer Group 的每个 Consumer 实例平均分摊消息。")]),e._v(" "),r("p",[r("strong",[e._v("广播消费（Broadcasting）")]),e._v("：对应「发布订阅」 广播消费模式下，相同 Consumer Group 的每个 Consumer 实例都接收全量的消息。")])]),e._v(" "),r("p",[e._v("😈 考虑到艿艿自己的习惯，下文我们统一采用集群消费和广播消费叫法。")]),e._v(" "),r("p",[e._v("下面，我们分别在"),r("a",{attrs:{href:"https://www.iocoder.cn/Spring-Boot/ActiveMQ/?self#",target:"_blank",rel:"noopener noreferrer"}},[e._v("「4.1 集群消费」"),r("OutboundLink")],1),e._v("和"),r("a",{attrs:{href:"https://www.iocoder.cn/Spring-Boot/ActiveMQ/?self#",target:"_blank",rel:"noopener noreferrer"}},[e._v("「4.2 广播消费」"),r("OutboundLink")],1),e._v("的示例代码。两个示例，我们都会放在一个 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-32/lab-32-activemq-demo-message-model",target:"_blank",rel:"noopener noreferrer"}},[e._v("lab-32-activemq-demo-message-model"),r("OutboundLink")],1),e._v(" 项目。")]),e._v(" "),r("h2",{attrs:{id:"_4-1-集群消费"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-集群消费"}},[e._v("#")]),e._v(" 4.1 集群消费")]),e._v(" "),r("p",[e._v("在 ActiveMQ 中，如果多个 Consumer 订阅相同的 Queue ，那么每一条消息有且仅会被一个 Consumer 所消费。这个特性，就为我们实现集群消费提供了基础。")]),e._v(" "),r("p",[e._v("在本示例中，我们会把一个 Queue 作为一个 Consumer Group ，同时创建消费该 Queue 的 Consumer 。这样，在我们启动多个 JVM 进程时，就会有多个 Consumer 消费该 Queue ，从而实现集群消费的效果。")]),e._v(" "),r("p",[e._v("下面，让我们开始集群消费的示例。")]),e._v(" "),r("h3",{attrs:{id:"_4-1-1-引入依赖"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-1-引入依赖"}},[e._v("#")]),e._v(" 4.1.1 引入依赖")]),e._v(" "),r("p",[e._v("和 "),r("a",{attrs:{href:"https://www.iocoder.cn/Spring-Boot/ActiveMQ/?self#",target:"_blank",rel:"noopener noreferrer"}},[e._v("「3.1 引入依赖」"),r("OutboundLink")],1),e._v(" 一致，见 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-32/lab-32-activemq-demo-message-model/pom.xml",target:"_blank",rel:"noopener noreferrer"}},[r("code",[e._v("pom.xml")]),r("OutboundLink")],1),e._v(" 文件。")]),e._v(" "),r("h3",{attrs:{id:"_4-1-2-应用配置文件"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-2-应用配置文件"}},[e._v("#")]),e._v(" 4.1.2 应用配置文件")]),e._v(" "),r("p",[e._v("和 "),r("a",{attrs:{href:"https://www.iocoder.cn/Spring-Boot/ActiveMQ/?self#",target:"_blank",rel:"noopener noreferrer"}},[e._v("「3.2 应用配置文件」"),r("OutboundLink")],1),e._v(" 一致，见 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-32/lab-32-activemq-demo-message-model/src/main/resources/application.yaml",target:"_blank",rel:"noopener noreferrer"}},[r("code",[e._v("application.yaml")]),r("OutboundLink")],1),e._v(" 文件。")]),e._v(" "),r("h3",{attrs:{id:"_4-1-3-clusteringmessage"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-3-clusteringmessage"}},[e._v("#")]),e._v(" 4.1.3 ClusteringMessage")]),e._v(" "),r("p",[e._v("在 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-32/lab-32-activemq-demo-message-model/src/main/java/cn/iocoder/springboot/lab32/activemqdemo/message/",target:"_blank",rel:"noopener noreferrer"}},[r("code",[e._v("cn.iocoder.springboot.lab32.activemqdemo.message")]),r("OutboundLink")],1),e._v(" 包下，创建 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-32/lab-32-activemq-demo-message-model/src/main/java/cn/iocoder/springboot/lab32/activemqdemo/message/ClusteringMessage.java",target:"_blank",rel:"noopener noreferrer"}},[e._v("ClusteringMessage"),r("OutboundLink")],1),e._v(" 消息类，提供给当前示例使用。代码如下：")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v('// ClusteringMessage.java\n\npublic class ClusteringMessage implements Serializable {\n\n    public static final String QUEUE = "QUEUE_CLUSTERING";\n\n    /**\n     * 编号\n     */\n    private Integer id;\n\n    // ... 省略 set/get/toString 方法\n\n}\n')])])]),r("ul",[r("li",[e._v("在消息类里，我们枚举了 Queue 的名字。")])]),e._v(" "),r("h3",{attrs:{id:"_4-1-4-activemqconfig"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-4-activemqconfig"}},[e._v("#")]),e._v(" 4.1.4 ActiveMQConfig")]),e._v(" "),r("p",[e._v("在 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-32/lab-32-activemq-demo-message-model/src/main/java/cn/iocoder/springboot/lab32/activemqdemo/config",target:"_blank",rel:"noopener noreferrer"}},[r("code",[e._v("cn.iocoder.springboot.lab32.activemqdemo.config")]),r("OutboundLink")],1),e._v(" 包下，创建 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-32/lab-32-activemq-demo-message-model/src/main/java/cn/iocoder/springboot/lab32/activemqdemo/config/ActiveMQConfig.java",target:"_blank",rel:"noopener noreferrer"}},[e._v("ActiveMQConfig"),r("OutboundLink")],1),e._v(" 配置类，添加集群消费需要的配置。代码如下：")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v('// ActiveMQConfig.java\n\npublic static final String CLUSTERING_JMS_LISTENER_CONTAINER_FACTORY_BEAN_NAME = "clusteringJmsListenerContainerFactory";\n\npublic static final String CLUSTERING_JMS_TEMPLATE_BEAN_NAME = "clusteringJmsTemplate";\n\n@Bean(CLUSTERING_JMS_LISTENER_CONTAINER_FACTORY_BEAN_NAME)\npublic DefaultJmsListenerContainerFactory clusteringJmsListenerContainerFactory(\n        DefaultJmsListenerContainerFactoryConfigurer configurer, ConnectionFactory connectionFactory) {\n    DefaultJmsListenerContainerFactory factory = new DefaultJmsListenerContainerFactory();\n    configurer.configure(factory, connectionFactory);\n    factory.setPubSubDomain(false);\n    return factory;\n}\n\n@Bean(CLUSTERING_JMS_TEMPLATE_BEAN_NAME)\npublic JmsMessagingTemplate clusteringJmsTemplate(ConnectionFactory connectionFactory) {\n    // 创建 JmsTemplate 对象\n    JmsTemplate template = new JmsTemplate(connectionFactory);\n    template.setPubSubDomain(false);\n    // 创建 JmsMessageTemplate\n    return new JmsMessagingTemplate(template);\n}\n')])])]),r("ul",[r("li",[r("p",[e._v("通过")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("spring.jms.pub-sub-domain\n")])])]),r("p",[e._v("配置项，控制创建的 JmsTemplate 和 DefaultJmsListenerContainerFactory Bean 是针对")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("true\n")])])]),r("p",[e._v("广播消费，还是")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("false\n")])])]),r("p",[e._v("集群消费。")]),e._v(" "),r("ul",[r("li",[e._v("因为在本小节的示例项目中，我们既要支持集群消费，又要支持广播消费，所以我们需要"),r("strong",[e._v("手动")]),e._v("创建两套 JmsTemplate 和 DefaultJmsListenerContainerFactory Bean ，分别给"),r("a",{attrs:{href:"https://www.iocoder.cn/Spring-Boot/ActiveMQ/?self#",target:"_blank",rel:"noopener noreferrer"}},[e._v("「4.1 集群消费」"),r("OutboundLink")],1),e._v("和"),r("a",{attrs:{href:"https://www.iocoder.cn/Spring-Boot/ActiveMQ/?self#",target:"_blank",rel:"noopener noreferrer"}},[e._v("「4.2 广播消费」"),r("OutboundLink")],1),e._v("使用。在这里，我们先给集群消费创建了一套 JmsTemplate 和 DefaultJmsListenerContainerFactory 。")]),e._v(" "),r("li",[e._v("如果胖友的项目中，只需要持集群消费或广播消费的其中一种，仅仅需要 "),r("code",[e._v("spring.jms.pub-sub-domain")]),e._v(" 配置项即可，无需"),r("strong",[e._v("手动")]),e._v("一套 JmsTemplate 和 DefaultJmsListenerContainerFactory Bean 。")])])]),e._v(" "),r("li",[r("p",[e._v("另外，因为我们在 Producer 中，使用的是 JmsMessagingTemplate 来发送消息，所以这里最终创建的是 JmsMessagingTemplate Bean 。")])])]),e._v(" "),r("h3",{attrs:{id:"_4-1-5-clusteringproducer"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-5-clusteringproducer"}},[e._v("#")]),e._v(" 4.1.5 ClusteringProducer")]),e._v(" "),r("p",[e._v("在 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-32/lab-32-activemq-demo-message-model/src/main/java/cn/iocoder/springboot/lab32/activemqdemo/producer",target:"_blank",rel:"noopener noreferrer"}},[r("code",[e._v("cn.iocoder.springboot.lab32.activemqdemo.producer")]),r("OutboundLink")],1),e._v(" 包下，创建 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-32/lab-32-activemq-demo-message-model/src/main/java/cn/iocoder/springboot/lab32/activemqdemo/producer/ClusteringProducer.java",target:"_blank",rel:"noopener noreferrer"}},[e._v("ClusteringProducer"),r("OutboundLink")],1),e._v(" 类，它会使用 Spring-JMS 封装提供的 JmsMessagingTemplate ，实现发送消息。代码如下：")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("// ClusteringProducer.java\n\n@Component\npublic class ClusteringProducer {\n\n    @Resource(name = ActiveMQConfig.CLUSTERING_JMS_TEMPLATE_BEAN_NAME)\n    private JmsMessagingTemplate jmsTemplate;\n\n    public void syncSend(Integer id) {\n        // 创建 ClusteringMessage 消息\n        ClusteringMessage message = new ClusteringMessage();\n        message.setId(id);\n        // 同步发送消息\n        jmsTemplate.convertAndSend(ClusteringMessage.QUEUE, message);\n    }\n\n}\n")])])]),r("ul",[r("li",[e._v("注意，要注入对应的 Bean 名字为 "),r("code",[e._v("ActiveMQConfig.CLUSTERING_JMS_TEMPLATE_BEAN_NAME")]),e._v(" 的 JmsMessagingTemplate 对象。")])]),e._v(" "),r("h3",{attrs:{id:"_4-1-6-clusteringconsumer"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-6-clusteringconsumer"}},[e._v("#")]),e._v(" 4.1.6 ClusteringConsumer")]),e._v(" "),r("p",[e._v("在 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-32/lab-32-activemq-demo-message-model/src/main/java/cn/iocoder/springboot/lab32/activemqdemo/consumer",target:"_blank",rel:"noopener noreferrer"}},[r("code",[e._v("cn.iocoder.springboot.lab32.activemqdemo.consumer")]),r("OutboundLink")],1),e._v(" 包下，创建 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-32/lab-32-activemq-demo-message-model/src/main/java/cn/iocoder/springboot/lab32/activemqdemo/consumer/ClusteringConsumer.java",target:"_blank",rel:"noopener noreferrer"}},[e._v("ClusteringConsumer"),r("OutboundLink")],1),e._v(" 类，"),r("strong",[e._v("集群")]),e._v("消费消息。代码如下：")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v('// ClusteringConsumer.java\n\n@Component\npublic class ClusteringConsumer {\n\n    private Logger logger = LoggerFactory.getLogger(getClass());\n\n    @JmsListener(destination = ClusteringMessage.QUEUE,\n            containerFactory = ActiveMQConfig.CLUSTERING_JMS_LISTENER_CONTAINER_FACTORY_BEAN_NAME)\n    public void onMessage(ClusteringMessage message) {\n        logger.info("[onMessage][线程编号:{} 消息内容：{}]", Thread.currentThread().getId(), message);\n    }\n\n}\n')])])]),r("ul",[r("li",[e._v("在 "),r("code",[e._v("@JmsListener")]),e._v(" 注解的 "),r("code",[e._v("containerFactory")]),e._v(" 属性，设置 Bean 名字为 "),r("code",[e._v("ActiveMQConfig.CLUSTERING_JMS_TEMPLATE_BEAN_NAME")]),e._v(" 的 DefaultJmsListenerContainerFactory 对象。")])]),e._v(" "),r("h3",{attrs:{id:"_4-1-7-简单测试"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-7-简单测试"}},[e._v("#")]),e._v(" 4.1.7 简单测试")]),e._v(" "),r("p",[e._v("创建 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-32/lab-32-activemq-demo-message-model/src/test/java/cn/iocoder/springboot/lab32/activemqdemo/producer/ClusteringProducerTest.java",target:"_blank",rel:"noopener noreferrer"}},[e._v("ClusteringProducerTest"),r("OutboundLink")],1),e._v(" 测试类，用于测试集群消费。代码如下：")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v('// ClusteringProducerTest.java\n\n@RunWith(SpringRunner.class)\n@SpringBootTest(classes = Application.class)\npublic class ClusteringProducerTest {\n\n    private Logger logger = LoggerFactory.getLogger(getClass());\n\n    @Autowired\n    private ClusteringProducer producer;\n\n    @Test\n    public void mock() throws InterruptedException {\n        // 阻塞等待，保证消费\n        new CountDownLatch(1).await();\n    }\n\n    @Test\n    public void testSyncSend() throws InterruptedException {\n        // 发送 3 条消息\n        for (int i = 0; i < 3; i++) {\n            int id = (int) (System.currentTimeMillis() / 1000);\n            producer.syncSend(id);\n            logger.info("[testSyncSend][发送编号：[{}] 发送成功]", id);\n        }\n\n        // 阻塞等待，保证消费\n        new CountDownLatch(1).await();\n    }\n\n}\n')])])]),r("p",[e._v("首先，执行 "),r("code",[e._v("#mock()")]),e._v(" 测试方法，先启动一个消费 "),r("code",[e._v('"QUEUE_CLUSTERING"')]),e._v(" 这个 Queue 的 Consumer 节点。")]),e._v(" "),r("p",[e._v("然后，执行 "),r("code",[e._v("#testSyncSend()")]),e._v(" 测试方法，再启动一个消费 "),r("code",[e._v('"QUEUE_CLUSTERING"')]),e._v(" 这个 Queue 的 Consumer 节点。同时，该测试方法，调用 "),r("code",[e._v("ClusteringProducer#syncSend(id)")]),e._v(" 方法，同步发送了 3 条消息。控制台输出如下：")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("// #### testSyncSend 方法对应的控制台 ####\n\n# Producer 同步发送消息成功\n2019-12-15 13:43:07.010  INFO 79244 --- [           main] c.i.s.l.a.p.ClusteringProducerTest       : [testSyncSend][发送编号：[1576388586] 发送成功]\n2019-12-15 13:43:07.015  INFO 79244 --- [           main] c.i.s.l.a.p.ClusteringProducerTest       : [testSyncSend][发送编号：[1576388587] 发送成功]\n2019-12-15 13:43:07.017  INFO 79244 --- [           main] c.i.s.l.a.p.ClusteringProducerTest       : [testSyncSend][发送编号：[1576388587] 发送成功]\n\n# ClusteringConsumer 消费了 1 条消息\n2019-12-15 13:43:07.021  INFO 79244 --- [enerContainer-1] c.i.s.l.a.consumer.ClusteringConsumer    : [onMessage][线程编号:18 消息内容：ClusteringtMessage{id=1576388587}]\n\n// ### mock 方法对应的控制台 ####\n\n# ClusteringConsumer 消费了 2 条消息\n2019-12-15 13:43:07.029  INFO 79234 --- [enerContainer-1] c.i.s.l.a.consumer.ClusteringConsumer    : [onMessage][线程编号:18 消息内容：ClusteringtMessage{id=1576388586}]\n2019-12-15 13:43:07.034  INFO 79234 --- [enerContainer-1] c.i.s.l.a.consumer.ClusteringConsumer    : [onMessage][线程编号:18 消息内容：ClusteringtMessage{id=1576388587}\n")])])]),r("ul",[r("li",[e._v("3 条消息，都仅被 "),r("strong",[e._v("两个")]),e._v(" Consumer 节点的"),r("strong",[e._v("一个")]),e._v("进行消费。符合集群消费的预期~")])]),e._v(" "),r("h3",{attrs:{id:"_4-1-8-多集群下的集群消费"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-8-多集群下的集群消费"}},[e._v("#")]),e._v(" 4.1.8 多集群下的集群消费")]),e._v(" "),r("p",[e._v("在"),r("a",{attrs:{href:"https://www.iocoder.cn/Spring-Boot/ActiveMQ/?self#",target:"_blank",rel:"noopener noreferrer"}},[e._v("「4.1 集群消费」"),r("OutboundLink")],1),e._v("的示例中，我们只提供了"),r("strong",[e._v("单集群")]),e._v("下的集群消费。实际业务场景下，我们可能会存在"),r("strong",[e._v("多集群")]),e._v("的集群消费。不了解的胖友，可以看看"),r("a",{attrs:{href:"https://www.cnblogs.com/Peter2014/p/9389600.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("《ActiveMQ 之 VirtualTopic 是什么？》"),r("OutboundLink")],1),e._v(" 。")]),e._v(" "),r("p",[e._v("正如该文章的标题，需要通过 ActiveMQ "),r("strong",[e._v("自定义")]),e._v("的 VirtualTopic 虚拟主题，而非 JMS 所提供的。具体的示例，胖友可以先看如下两篇文章：")]),e._v(" "),r("ul",[r("li",[r("a",{attrs:{href:"http://blog.sina.com.cn/s/blog_7d1968e20102wyq0.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("《springboot-29-activemq 虚拟主题实现消费者分组和简单路由》"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"https://blog.csdn.net/kimmking/article/details/9773085",target:"_blank",rel:"noopener noreferrer"}},[e._v("《ActiveMQ 高级特性：虚拟 Destinations 实现消费者分组与简单路由》"),r("OutboundLink")],1)])]),e._v(" "),r("h2",{attrs:{id:"_4-2-广播消费"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-广播消费"}},[e._v("#")]),e._v(" 4.2 广播消费")]),e._v(" "),r("p",[e._v("在 ActiveMQ 中，如果多个 Consumer 订阅相同的 Topic ，那么每一条消息"),r("strong",[e._v("都")]),e._v("会被一个 Consumer 所消费。这个特性，就为我们实现广播消费提供了基础。")]),e._v(" "),r("p",[e._v("下面，让我们开始集群消费的示例。")]),e._v(" "),r("h3",{attrs:{id:"_4-2-1-broadcastmessage"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-1-broadcastmessage"}},[e._v("#")]),e._v(" 4.2.1 BroadcastMessage")]),e._v(" "),r("p",[e._v("在 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-32/lab-32-activemq-demo-message-model/src/main/java/cn/iocoder/springboot/lab32/activemqdemo/message/",target:"_blank",rel:"noopener noreferrer"}},[r("code",[e._v("cn.iocoder.springboot.lab32.activemqdemo.message")]),r("OutboundLink")],1),e._v(" 包下，创建 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-32/lab-32-activemq-demo-message-model/src/main/java/cn/iocoder/springboot/lab32/activemqdemo/message/BroadcastMessage.java",target:"_blank",rel:"noopener noreferrer"}},[e._v("BroadcastMessage"),r("OutboundLink")],1),e._v(" 消息类，提供给当前示例使用。代码如下：")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v('// ClusteringMessage.java\n\npublic class BroadcastMessage implements Serializable {\n\n    public static final String TOPIC = "TOPIC_BROADCASTING";\n\n    /**\n     * 编号\n     */\n    private Integer id;\n\n    // ... 省略 set/get/toString 方法\n\n}\n')])])]),r("ul",[r("li",[e._v("在消息类里，我们枚举了 Topic 的名字。")])]),e._v(" "),r("h3",{attrs:{id:"_4-2-2-activemqconfig"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-2-activemqconfig"}},[e._v("#")]),e._v(" 4.2.2 ActiveMQConfig")]),e._v(" "),r("p",[e._v("修改 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-32/lab-32-activemq-demo-message-model/src/main/java/cn/iocoder/springboot/lab32/activemqdemo/config/ActiveMQConfig.java",target:"_blank",rel:"noopener noreferrer"}},[e._v("ActiveMQConfig"),r("OutboundLink")],1),e._v(" 配置类，添加广播消费需要的配置。代码如下：")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v('// ActiveMQConfig.java\n\npublic static final String BROADCAST_JMS_LISTENER_CONTAINER_FACTORY_BEAN_NAME = "broadcastJmsListenerContainerFactory";\n\npublic static final String BROADCAST_JMS_TEMPLATE_BEAN_NAME = "broadcastJmsTemplate";\n\n    @Bean(BROADCAST_JMS_LISTENER_CONTAINER_FACTORY_BEAN_NAME)\npublic DefaultJmsListenerContainerFactory broadcastJmsListenerContainerFactory(\n        DefaultJmsListenerContainerFactoryConfigurer configurer, ConnectionFactory connectionFactory) {\n    DefaultJmsListenerContainerFactory factory = new DefaultJmsListenerContainerFactory();\n    configurer.configure(factory, connectionFactory);\n    factory.setPubSubDomain(true);\n    return factory;\n}\n\n@Bean(BROADCAST_JMS_TEMPLATE_BEAN_NAME)\npublic JmsMessagingTemplate broadcastJmsTemplate(ConnectionFactory connectionFactory) {\n    // 创建 JmsTemplate 对象\n    JmsTemplate template = new JmsTemplate(connectionFactory);\n    template.setPubSubDomain(true);\n    // 创建 JmsMessageTemplate\n    return new JmsMessagingTemplate(template);\n}\n')])])]),r("ul",[r("li",[e._v("在这里，我们给集群消费创建了一套 JmsTemplate 和 DefaultJmsListenerContainerFactory 。")])]),e._v(" "),r("h3",{attrs:{id:"_4-2-3-broadcastproducer"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-3-broadcastproducer"}},[e._v("#")]),e._v(" 4.2.3 BroadcastProducer")]),e._v(" "),r("p",[e._v("在 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-32/lab-32-activemq-demo-message-model/src/main/java/cn/iocoder/springboot/lab32/activemqdemo/producer",target:"_blank",rel:"noopener noreferrer"}},[r("code",[e._v("cn.iocoder.springboot.lab32.activemqdemo.producer")]),r("OutboundLink")],1),e._v(" 包下，创建 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-32/lab-32-activemq-demo-message-model/src/main/java/cn/iocoder/springboot/lab32/activemqdemo/producer/BroadcastProducer.java",target:"_blank",rel:"noopener noreferrer"}},[e._v("BroadcastProducer"),r("OutboundLink")],1),e._v(" 类，它会使用 Spring-JMS 封装提供的 JmsMessagingTemplate ，实现发送消息。代码如下：")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("// BroadcastProducer.java\n\n@Component\npublic class BroadcastProducer {\n\n    @Resource(name = ActiveMQConfig.BROADCAST_JMS_TEMPLATE_BEAN_NAME)\n    private JmsMessagingTemplate jmsMessagingTemplate;\n\n    public void syncSend(Integer id) {\n        // 创建 BroadcastMessage 消息\n        BroadcastMessage message = new BroadcastMessage();\n        message.setId(id);\n        // 同步发送消息\n        jmsMessagingTemplate.convertAndSend(BroadcastMessage.TOPIC, message);\n    }\n\n}\n")])])]),r("ul",[r("li",[e._v("和"),r("a",{attrs:{href:"https://www.iocoder.cn/Spring-Boot/ActiveMQ/?self#",target:"_blank",rel:"noopener noreferrer"}},[e._v("「4.1.5 ClusteringProducer」"),r("OutboundLink")],1),e._v("是一致，只是使用了不同的 Topic 和消息。")]),e._v(" "),r("li",[e._v("注意，要注入对应的 Bean 名字为 "),r("code",[e._v("ActiveMQConfig.BROADCAST_JMS_TEMPLATE_BEAN_NAME")]),e._v(" 的 JmsMessagingTemplate 对象。")])]),e._v(" "),r("h3",{attrs:{id:"_4-2-4-broadcastconsumer"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-4-broadcastconsumer"}},[e._v("#")]),e._v(" 4.2.4 BroadcastConsumer")]),e._v(" "),r("p",[e._v("在 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-32/lab-32-activemq-demo-message-model/src/main/java/cn/iocoder/springboot/lab32/activemqdemo/consumer",target:"_blank",rel:"noopener noreferrer"}},[r("code",[e._v("cn.iocoder.springboot.lab32.activemqdemo.consumer")]),r("OutboundLink")],1),e._v(" 包下，创建 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-32/lab-32-activemq-demo-message-model/src/main/java/cn/iocoder/springboot/lab32/activemqdemo/consumer/BroadcastConsumer.java",target:"_blank",rel:"noopener noreferrer"}},[e._v("BroadcastConsumer"),r("OutboundLink")],1),e._v(" 类，"),r("strong",[e._v("广播")]),e._v("消费消息。代码如下：")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v('// BroadcastConsumer.java\n\n@Component\npublic class BroadcastConsumer {\n\n    private Logger logger = LoggerFactory.getLogger(getClass());\n\n    @JmsListener(destination = BroadcastMessage.TOPIC,\n            containerFactory = ActiveMQConfig.BROADCAST_JMS_LISTENER_CONTAINER_FACTORY_BEAN_NAME)\n    public void onMessage(BroadcastMessage message) {\n        logger.info("[onMessage][线程编号:{} 消息内容：{}]", Thread.currentThread().getId(), message);\n    }\n\n}\n')])])]),r("ul",[r("li",[e._v("总体和"),r("a",{attrs:{href:"https://www.iocoder.cn/Spring-Boot/ActiveMQ/?self#",target:"_blank",rel:"noopener noreferrer"}},[e._v("「4.1.6 ClusteringConsumer」"),r("OutboundLink")],1),e._v("是一致的。")]),e._v(" "),r("li",[e._v("在 "),r("code",[e._v("@JmsListener")]),e._v(" 注解的 "),r("code",[e._v("containerFactory")]),e._v(" 属性，设置 Bean 名字为 "),r("code",[e._v("ActiveMQConfig.BROADCAST_JMS_LISTENER_CONTAINER_FACTORY_BEAN_NAME")]),e._v(" 的 DefaultJmsListenerContainerFactory 对象。")])]),e._v(" "),r("h3",{attrs:{id:"_4-2-5-简单测试"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-5-简单测试"}},[e._v("#")]),e._v(" 4.2.5 简单测试")]),e._v(" "),r("p",[e._v("创建 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-32/lab-32-activemq-demo-message-model/src/test/java/cn/iocoder/springboot/lab32/activemqdemo/producer/BroadcastProducerTest.java",target:"_blank",rel:"noopener noreferrer"}},[e._v("BroadcastProducerTest"),r("OutboundLink")],1),e._v(" 测试类，用于测试广播消费。代码如下：")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v('// BroadcastProducerTest.java\n\n@RunWith(SpringRunner.class)\n@SpringBootTest(classes = Application.class)\npublic class BroadcastProducerTest {\n\n    private Logger logger = LoggerFactory.getLogger(getClass());\n\n    @Autowired\n    private BroadcastProducer producer;\n\n    @Test\n    public void mock() throws InterruptedException {\n        // 阻塞等待，保证消费\n        new CountDownLatch(1).await();\n    }\n\n    @Test\n    public void testSyncSend() throws InterruptedException {\n        for (int i = 0; i < 3; i++) {\n            int id = (int) (System.currentTimeMillis() / 1000);\n            producer.syncSend(id);\n            logger.info("[testSyncSend][发送编号：[{}] 发送成功]", id);\n        }\n\n        // 阻塞等待，保证消费\n        new CountDownLatch(1).await();\n    }\n\n}\n')])])]),r("p",[e._v("首先，执行 "),r("code",[e._v("#mock()")]),e._v(" 测试方法，先启动一个消费 "),r("code",[e._v('"TOPIC_BROADCASTING"')]),e._v(" 这个 Topic 的 Consumer 节点。")]),e._v(" "),r("p",[e._v("然后，执行 "),r("code",[e._v("#testSyncSend()")]),e._v(" 测试方法，再启动一个消费 "),r("code",[e._v('"TOPIC_BROADCASTING"')]),e._v(" 这个 Topic 的 Consumer 节点。同时，该测试方法，调用 "),r("code",[e._v("BroadcastProducer#syncSend(id)")]),e._v(" 方法，同步发送了 3 条消息。控制台输出如下：")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("// #### testSyncSend 方法对应的控制台 ####\n\n# Producer 同步发送消息成功\n2019-12-15 14:11:41.256  INFO 80487 --- [           main] c.i.s.l.a.p.BroadcastProducerTest        : [testSyncSend][发送编号：[1576390301] 发送成功]\n2019-12-15 14:11:41.258  INFO 80487 --- [           main] c.i.s.l.a.p.BroadcastProducerTest        : [testSyncSend][发送编号：[1576390301] 发送成功]\n2019-12-15 14:11:41.259  INFO 80487 --- [           main] c.i.s.l.a.p.BroadcastProducerTest        : [testSyncSend][发送编号：[1576390301] 发送成功]\n\n# BroadcastConsumer 消费了 3 条消息\n2019-12-15 14:11:41.259  INFO 80487 --- [enerContainer-1] c.i.s.l.a.consumer.BroadcastConsumer     : [onMessage][线程编号:19 消息内容：BroadcastMessage{id=1576390301}]\n2019-12-15 14:11:41.261  INFO 80487 --- [enerContainer-1] c.i.s.l.a.consumer.BroadcastConsumer     : [onMessage][线程编号:19 消息内容：BroadcastMessage{id=1576390301}]\n2019-12-15 14:11:41.263  INFO 80487 --- [enerContainer-1] c.i.s.l.a.consumer.BroadcastConsumer     : [onMessage][线程编号:19 消息内容：BroadcastMessage{id=1576390301}]\n\n// ### mock 方法对应的控制台 ####\n\n# BroadcastConsumer 也消费了 3 条消\n2019-12-15 14:11:41.275  INFO 80478 --- [enerContainer-1] c.i.s.l.a.consumer.BroadcastConsumer     : [onMessage][线程编号:19 消息内容：BroadcastMessage{id=1576390301}]\n2019-12-15 14:11:41.278  INFO 80478 --- [enerContainer-1] c.i.s.l.a.consumer.BroadcastConsumer     : [onMessage][线程编号:19 消息内容：BroadcastMessage{id=1576390301}]\n2019-12-15 14:11:41.279  INFO 80478 --- [enerContainer-1] c.i.s.l.a.consumer.BroadcastConsumer     : [onMessage][线程编号:19 消息内容：BroadcastMessage{id=1576390301}]\n")])])]),r("ul",[r("li",[r("strong",[e._v("两个")]),e._v(" Consumer 节点，都消费了这条发送的消息。符合广播消费的预期~")])]),e._v(" "),r("h1",{attrs:{id:"_5-定时消息"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_5-定时消息"}},[e._v("#")]),e._v(" 5. 定时消息")]),e._v(" "),r("blockquote",[r("p",[e._v("示例代码对应仓库："),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-32/lab-32-activemq-demo-delay",target:"_blank",rel:"noopener noreferrer"}},[e._v("lab-32-activemq-demo-delay"),r("OutboundLink")],1)])]),e._v(" "),r("p",[e._v("ActiveMQ 内置了对定时消息的支持，不了解的胖友，可以看看如下文档：")]),e._v(" "),r("ul",[r("li",[r("a",{attrs:{href:"http://activemq.apache.org/delay-and-schedule-message-delivery.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("《ActiveMQ 官方文档 —— Delay and Schedule Message Delivery》"),r("OutboundLink")],1)]),e._v(" "),r("li",[r("a",{attrs:{href:"https://blog.csdn.net/KimmKing/article/details/8443872",target:"_blank",rel:"noopener noreferrer"}},[e._v("《ActiveMQ 消息特性：延迟和定时消息投递（Delay and Schedule Message Delivery）》"),r("OutboundLink")],1)])]),e._v(" "),r("p",[e._v("默认情况下，ActiveMQ 默认未开启定时消息的功能，需要我们"),r("strong",[e._v("手动")]),e._v("去配置开启。通过编辑 "),r("code",[e._v("conf/activemq.xml")]),e._v(" 配置文件，添加 "),r("code",[e._v('schedulerSupport="true"')]),e._v(" 来开启。示例如下：")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v('\x3c!--\n    The <broker> element is used to configure the ActiveMQ broker.\n--\x3e\n<broker xmlns="http://activemq.apache.org/schema/core" brokerName="localhost" dataDirectory="${activemq.data}" schedulerSupport="true">\n')])])]),r("p",[e._v("配置完成，通过 "),r("code",[e._v("bin/macosx/activemq restart")]),e._v(" 将 ActiveMQ 重启即可生效。")]),e._v(" "),r("p",[e._v("下面，我们来实现一个定时消息的示例。考虑到不污染上述的示例，我们新建一个 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-32/lab-32-activemq-demo-delay",target:"_blank",rel:"noopener noreferrer"}},[e._v("lab-32-activemq-demo-delay"),r("OutboundLink")],1),e._v(" 项目。")]),e._v(" "),r("h2",{attrs:{id:"_5-1-引入依赖"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-引入依赖"}},[e._v("#")]),e._v(" 5.1 引入依赖")]),e._v(" "),r("p",[e._v("和 "),r("a",{attrs:{href:"https://www.iocoder.cn/Spring-Boot/ActiveMQ/?self#",target:"_blank",rel:"noopener noreferrer"}},[e._v("「3.1 引入依赖」"),r("OutboundLink")],1),e._v(" 一致，见 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-32/lab-32-activemq-demo-delay/pom.xml",target:"_blank",rel:"noopener noreferrer"}},[r("code",[e._v("pom.xml")]),r("OutboundLink")],1),e._v(" 文件。")]),e._v(" "),r("h2",{attrs:{id:"_5-2-应用配置文件"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-应用配置文件"}},[e._v("#")]),e._v(" 5.2 应用配置文件")]),e._v(" "),r("p",[e._v("和 "),r("a",{attrs:{href:"https://www.iocoder.cn/Spring-Boot/ActiveMQ/?self#",target:"_blank",rel:"noopener noreferrer"}},[e._v("「3.2 应用配置文件」"),r("OutboundLink")],1),e._v(" 一致，见 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-32/lab-32-activemq-demo-delay/src/main/resources/application.yaml",target:"_blank",rel:"noopener noreferrer"}},[r("code",[e._v("application.yaml")]),r("OutboundLink")],1),e._v(" 文件。")]),e._v(" "),r("h2",{attrs:{id:"_5-3-demo02message"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_5-3-demo02message"}},[e._v("#")]),e._v(" 5.3 Demo02Message")]),e._v(" "),r("p",[e._v("在 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-32/lab-32-activemq-demo-delay/src/main/java/cn/iocoder/springboot/lab32/activemqdemo/message",target:"_blank",rel:"noopener noreferrer"}},[r("code",[e._v("cn.iocoder.springboot.lab32.activemqdemo.message")]),r("OutboundLink")],1),e._v(" 包下，创建 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-32/lab-32-activemq-demo-delay/src/main/java/cn/iocoder/springboot/lab32/activemqdemo/message/Demo02Message.java",target:"_blank",rel:"noopener noreferrer"}},[e._v("Demo02Message"),r("OutboundLink")],1),e._v(" 消息类，提供给当前示例使用。")]),e._v(" "),r("p",[e._v("和"),r("a",{attrs:{href:"https://www.iocoder.cn/Spring-Boot/ActiveMQ/?self#",target:"_blank",rel:"noopener noreferrer"}},[e._v("「3.4 Demo01Message」"),r("OutboundLink")],1),e._v("一致，只是 Queue 名字不同。")]),e._v(" "),r("h2",{attrs:{id:"_5-4-demo02producer"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_5-4-demo02producer"}},[e._v("#")]),e._v(" 5.4 Demo02Producer")]),e._v(" "),r("p",[e._v("在 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-32/lab-32-activemq-demo-delay/src/main/java/cn/iocoder/springboot/lab32/activemqdemo/producer",target:"_blank",rel:"noopener noreferrer"}},[r("code",[e._v("cn.iocoder.springboot.lab32.activemqdemo.producer")]),r("OutboundLink")],1),e._v(" 包下，创建 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-32/lab-32-activemq-demo-delay/src/main/java/cn/iocoder/springboot/lab32/activemqdemo/producer/Demo02Producer.java",target:"_blank",rel:"noopener noreferrer"}},[e._v("Demo02Producer"),r("OutboundLink")],1),e._v(" 类，它会使用 Spring-JMS 封装提供的 JmsMessagingTemplate ，实现发送"),r("strong",[e._v("定时")]),e._v("消息。代码如下：")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("// Demo02Producer.java\n\n@Component\npublic class Demo02Producer {\n\n    @Autowired\n    private JmsMessagingTemplate jmsTemplate;\n\n    public void syncSend(Integer id, Integer delay) {\n        // 创建 Demo02Message 消息\n        Demo02Message message = new Demo02Message();\n        message.setId(id);\n        // 创建 Header\n        Map<String, Object> headers = null;\n        if (delay != null && delay > 0) {\n            headers = new HashMap<>();\n            headers.put(ScheduledMessage.AMQ_SCHEDULED_DELAY, delay);\n        }\n        // 同步发送消息\n        jmsTemplate.convertAndSend(Demo02Message.QUEUE, message, headers);\n    }\n\n}\n")])])]),r("ul",[r("li",[e._v("调用 "),r("code",[e._v("#syncSend(Integer id, Integer delay)")]),e._v(" 方法来发送消息时，如果传递了方法参数 "),r("code",[e._v("delay")]),e._v(" ，则我们会设置到消息的 Header 的 "),r("code",[e._v("AMQ_SCHEDULED_DELAY")]),e._v(" 中，实现延迟 "),r("code",[e._v("delay")]),e._v(" 毫秒的定时消息。")])]),e._v(" "),r("h2",{attrs:{id:"_5-5-demo02consumer"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_5-5-demo02consumer"}},[e._v("#")]),e._v(" 5.5 Demo02Consumer")]),e._v(" "),r("p",[e._v("在 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-32/lab-32-activemq-demo-delay/src/main/java/cn/iocoder/springboot/lab32/activemqdemo/consumer",target:"_blank",rel:"noopener noreferrer"}},[r("code",[e._v("cn.iocoder.springboot.lab32.activemqdemo.consumer")]),r("OutboundLink")],1),e._v(" 包下，创建 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-32/lab-32-activemq-demo-delay/src/main/java/cn/iocoder/springboot/lab32/activemqdemo/consumer/Demo02Consumer.java",target:"_blank",rel:"noopener noreferrer"}},[e._v("Demo02Consumer"),r("OutboundLink")],1),e._v(" 类，消费消息。")]),e._v(" "),r("p",[e._v("和"),r("a",{attrs:{href:"https://www.iocoder.cn/Spring-Boot/ActiveMQ/?self#",target:"_blank",rel:"noopener noreferrer"}},[e._v("「3.6 Demo01Consumer」"),r("OutboundLink")],1),e._v("基本一致，差别在于消费的队列是 "),r("code",[e._v('"QUEUE_DEMO_02"')]),e._v(" 。")]),e._v(" "),r("h2",{attrs:{id:"_5-6-简单测试"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_5-6-简单测试"}},[e._v("#")]),e._v(" 5.6 简单测试")]),e._v(" "),r("p",[e._v("创建 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-32/lab-32-activemq-demo-delay/src/test/java/cn/iocoder/springboot/lab32/activemqdemo/producer/Demo02ProducerTest.java",target:"_blank",rel:"noopener noreferrer"}},[e._v("Demo02ProducerTest"),r("OutboundLink")],1),e._v(" 测试类，编写单元测试方法，测试"),r("strong",[e._v("定时消息")]),e._v("的效果。代码如下：")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v('// Demo02ProducerTest.java\n\n@RunWith(SpringRunner.class)\n@SpringBootTest(classes = Application.class)\npublic class Demo02ProducerTest {\n\n    private Logger logger = LoggerFactory.getLogger(getClass());\n\n    @Autowired\n    private Demo02Producer producer;\n\n    @Test\n    public void testSyncSend01() throws InterruptedException {\n        // 不设置消息的过期时间\n        this.testSyncSendDelay(null);\n    }\n\n    @Test\n    public void testSyncSend02() throws InterruptedException {\n        // 设置发送消息的过期时间为 5000 毫秒\n        this.testSyncSendDelay(5000);\n    }\n\n    private void testSyncSendDelay(Integer delay) throws InterruptedException {\n        int id = (int) (System.currentTimeMillis() / 1000);\n        producer.syncSend(id, delay);\n        logger.info("[testSyncSendDelay][发送编号：[{}] 发送成功]", id);\n\n        // 阻塞等待，保证消费\n        new CountDownLatch(1).await();\n    }\n\n}\n')])])]),r("ul",[r("li",[r("code",[e._v("#testSyncSend01()")]),e._v(" 方法，不设置消息的过期时间。")]),e._v(" "),r("li",[r("code",[e._v("#testSyncSend02()")]),e._v(" 方法，发送消息的"),r("strong",[e._v("过期时间为 5000 毫秒")]),e._v("。")])]),e._v(" "),r("p",[e._v("我们先来执行 "),r("code",[e._v("#testSyncSend01()")]),e._v(" 方法，不设置消息的过期时间。控制台输出如下：")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("# Producer 同步发送消息成功。\n2019-12-15 17:40:07.597  INFO 84240 --- [           main] c.i.s.l.a.producer.Demo02ProducerTest    : [testSyncSendDelay][发送编号：[1576402807] 发送成功]\n\n# Consumer 立即消费到该消息\n2019-12-15 17:40:07.599  INFO 84240 --- [enerContainer-1] c.i.s.l.a.consumer.Demo02Consumer        : [onMessage][线程编号:18 消息内容：Demo01Message{id=1576402807}]\n")])])]),r("ul",[r("li",[e._v("符合预期，消息被 Consumer 立即消费。")])]),e._v(" "),r("p",[e._v("我们再来执行 "),r("code",[e._v("#testSyncSend02()")]),e._v(" 方法，发送消息的"),r("strong",[e._v("过期时间为 5000 毫秒")]),e._v("。控制台输出如下：")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("# Producer 同步发送消息成功。\n2019-12-15 17:42:34.560  INFO 84344 --- [           main] c.i.s.l.a.producer.Demo02ProducerTest    : [testSyncSendDelay][发送编号：[1576402954] 发送成功]\n\n# Consumer 5 秒后，消费到该消息\n2019-12-15 17:42:40.010  INFO 84344 --- [enerContainer-1] c.i.s.l.a.consumer.Demo02Consumer        : [onMessage][线程编号:18 消息内容：Demo02Message{id=1576402954}]\n")])])]),r("ul",[r("li",[e._v("符合预期，消息 5 秒后被 Consumer 立即消费。")])]),e._v(" "),r("h1",{attrs:{id:"_6-并发消费"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_6-并发消费"}},[e._v("#")]),e._v(" 6. 并发消费")]),e._v(" "),r("blockquote",[r("p",[e._v("示例代码对应仓库："),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-32/lab-32-activemq-demo-concurrency",target:"_blank",rel:"noopener noreferrer"}},[e._v("lab-32-activemq-demo-concurrency"),r("OutboundLink")],1)])]),e._v(" "),r("p",[e._v("在上述的示例中，我们配置的每一个 Spring-JMS "),r("code",[e._v("@JmsListener")]),e._v(" ，都是"),r("strong",[e._v("串行")]),e._v("消费的。显然，这在监听的 Queue 每秒消息量比较大的时候，会导致消费不及时，导致消息积压的问题。")]),e._v(" "),r("p",[e._v("虽然说，我们可以通过启动多个 JVM 进程，实现"),r("strong",[e._v("多进程的并发消费")]),e._v("，从而加速消费的速度。但是问题是，否能够实现"),r("strong",[e._v("多线程")]),e._v("的并发消费呢？答案是"),r("strong",[e._v("有")]),e._v("。")]),e._v(" "),r("p",[e._v("在 "),r("code",[e._v("@JmsListener")]),e._v(" 注解中，有 "),r("code",[e._v("concurrency")]),e._v(" 属性，它可以指定并发消费的线程数。例如说，如果设置 "),r("code",[e._v("concurrency=4")]),e._v(" 时，Spring-AMQP 就会为"),r("strong",[e._v("该")]),e._v(" "),r("code",[e._v("@JmsListener")]),e._v(" 创建"),r("strong",[e._v("至多")]),e._v(" 4 个线程，进行并发消费。")]),e._v(" "),r("p",[e._v("考虑到让胖友能够更好的理解 "),r("code",[e._v("concurrency")]),e._v(" 属性，我们来简单说说 Spring-JMS 在这块的实现方式。我们来举个例子：")]),e._v(" "),r("ul",[r("li",[e._v("首先，我们来创建一个 Queue 为 "),r("code",[e._v('"DEMO_03"')]),e._v(" 。")]),e._v(" "),r("li",[e._v("然后，我们创建一个 Demo03Consumer 类，并在其消费方法上，添加 "),r("code",[e._v("@JmsListener(concurrency=2)")]),e._v(" 注解。")]),e._v(" "),r("li",[e._v("再然后，我们启动项目。Spring-AMQP 会根据 "),r("code",[e._v("@JmsListener(concurrency=2)")]),e._v(" 注解，创建 "),r("strong",[e._v("2")]),e._v(" 个 ActiveMQ Consumer 。注意噢，是 "),r("strong",[e._v("2")]),e._v(" 个 ActiveMQ Consumer 呢！！！后续，每个 ActiveMQ Consumer 会被"),r("strong",[e._v("单独")]),e._v("分配到一个线程中，进行拉取消息，消费消息。")])]),e._v(" "),r("p",[e._v("酱紫讲解一下，胖友对 Spring-JMS 实现"),r("strong",[e._v("多线程")]),e._v("的并发消费的机制，是否理解了。")]),e._v(" "),r("p",[e._v("下面，我们开始本小节的示例。本示例就是上述举例的具体实现。考虑到不污染上述的示例，我们新建一个 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-32/lab-32-activemq-demo-concurrency",target:"_blank",rel:"noopener noreferrer"}},[e._v("lab-32-activemq-demo-concurrency"),r("OutboundLink")],1),e._v(" 项目。")]),e._v(" "),r("h2",{attrs:{id:"_6-1-引入依赖"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_6-1-引入依赖"}},[e._v("#")]),e._v(" 6.1 引入依赖")]),e._v(" "),r("p",[e._v("和 "),r("a",{attrs:{href:"https://www.iocoder.cn/Spring-Boot/ActiveMQ/?self#",target:"_blank",rel:"noopener noreferrer"}},[e._v("「3.1 引入依赖」"),r("OutboundLink")],1),e._v(" 一致，见 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-32/lab-32-activemq-demo-concurrency/pom.xml",target:"_blank",rel:"noopener noreferrer"}},[r("code",[e._v("pom.xml")]),r("OutboundLink")],1),e._v(" 文件。")]),e._v(" "),r("h2",{attrs:{id:"_6-2-应用配置文件"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_6-2-应用配置文件"}},[e._v("#")]),e._v(" 6.2 应用配置文件")]),e._v(" "),r("p",[e._v("和 "),r("a",{attrs:{href:"https://www.iocoder.cn/Spring-Boot/ActiveMQ/?self#",target:"_blank",rel:"noopener noreferrer"}},[e._v("「3.2 应用配置文件」"),r("OutboundLink")],1),e._v(" 一致，见 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-32/lab-32-activemq-demo-concurrency/src/main/resources/application.yaml",target:"_blank",rel:"noopener noreferrer"}},[r("code",[e._v("application.yaml")]),r("OutboundLink")],1),e._v(" 文件。")]),e._v(" "),r("h2",{attrs:{id:"_6-3-demo03message"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_6-3-demo03message"}},[e._v("#")]),e._v(" 6.3 Demo03Message")]),e._v(" "),r("p",[e._v("在 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-32/lab-32-activemq-demo-concurrency/src/main/java/cn/iocoder/springboot/lab32/activemqdemo/message",target:"_blank",rel:"noopener noreferrer"}},[r("code",[e._v("cn.iocoder.springboot.lab32.activemqdemo.message")]),r("OutboundLink")],1),e._v(" 包下，创建 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-32/lab-32-activemq-demo-concurrency/src/main/java/cn/iocoder/springboot/lab32/activemqdemo/message/Demo03Message.java",target:"_blank",rel:"noopener noreferrer"}},[e._v("Demo03Message"),r("OutboundLink")],1),e._v(" 消息类，提供给当前示例使用。")]),e._v(" "),r("p",[e._v("和"),r("a",{attrs:{href:"https://www.iocoder.cn/Spring-Boot/ActiveMQ/?self#",target:"_blank",rel:"noopener noreferrer"}},[e._v("「3.4 Demo01Message」"),r("OutboundLink")],1),e._v("一致，只是 Queue 名字不同。")]),e._v(" "),r("h2",{attrs:{id:"_6-4-demo03producer"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_6-4-demo03producer"}},[e._v("#")]),e._v(" 6.4 Demo03Producer")]),e._v(" "),r("p",[e._v("在 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-32/lab-32-activemq-demo-concurrency/src/main/java/cn/iocoder/springboot/lab32/activemqdemo/producer/",target:"_blank",rel:"noopener noreferrer"}},[r("code",[e._v("cn.iocoder.springboot.lab32.activemqdemo.producer")]),r("OutboundLink")],1),e._v(" 包下，创建 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-32/lab-32-activemq-demo-concurrency/src/main/java/cn/iocoder/springboot/lab32/activemqdemo/producer/Demo03Producer.java",target:"_blank",rel:"noopener noreferrer"}},[e._v("Demo03Producer"),r("OutboundLink")],1),e._v(" 类，它会使用 Spring-JMS 封装提供的 JmsMessagingTemplate ，实现发送消息。")]),e._v(" "),r("p",[e._v("和"),r("a",{attrs:{href:"https://www.iocoder.cn/Spring-Boot/ActiveMQ/?self#",target:"_blank",rel:"noopener noreferrer"}},[e._v("「3.5 Demo01Producer」"),r("OutboundLink")],1),e._v("一致，只是 Queue 名字不同。")]),e._v(" "),r("h2",{attrs:{id:"_6-5-demo03consumer"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_6-5-demo03consumer"}},[e._v("#")]),e._v(" 6.5 Demo03Consumer")]),e._v(" "),r("p",[e._v("在 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-32/lab-32-activemq-demo-concurrency/src/main/java/cn/iocoder/springboot/lab32/activemqdemo/consumer/",target:"_blank",rel:"noopener noreferrer"}},[r("code",[e._v("cn.iocoder.springboot.lab32.activemqdemo.consumer")]),r("OutboundLink")],1),e._v(" 包下，创建 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-32/lab-32-activemq-demo-concurrency/src/main/java/cn/iocoder/springboot/lab32/activemqdemo/consumer/Demo03Consumer.java",target:"_blank",rel:"noopener noreferrer"}},[e._v("Demo03Consumer"),r("OutboundLink")],1),e._v(" 类，"),r("strong",[e._v("并发")]),e._v("消费消息。代码如下：")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v('// Demo03Consumer.java\n\n@Component\npublic class Demo03Consumer {\n\n    private Logger logger = LoggerFactory.getLogger(getClass());\n\n    @JmsListener(destination = Demo03Message.QUEUE,\n        concurrency = "2")\n    public void onMessage(Demo03Message message) {\n        logger.info("[onMessage][线程编号:{} 消息内容：{}]", Thread.currentThread().getId(), message);\n    }\n\n}\n')])])]),r("ul",[r("li",[e._v("和"),r("a",{attrs:{href:"https://www.iocoder.cn/Spring-Boot/ActiveMQ/?self#",target:"_blank",rel:"noopener noreferrer"}},[e._v("「3.6 Demo06Consumer」"),r("OutboundLink")],1),e._v("一致，只差在消费不同的队列。")]),e._v(" "),r("li",[e._v("【重要】另外，可以通过 "),r("code",[e._v("@JmsListener")]),e._v(" 注解的 "),r("code",[e._v("concurrency")]),e._v(" 属性，设置并发数为 "),r("strong",[e._v("2")]),e._v("。")])]),e._v(" "),r("h2",{attrs:{id:"_6-6-简单测试"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_6-6-简单测试"}},[e._v("#")]),e._v(" 6.6 简单测试")]),e._v(" "),r("p",[e._v("创建 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-32/lab-32-activemq-demo-concurrency/src/test/java/cn/iocoder/springboot/lab32/activemqdemo/producer/Demo03ProducerTest.java",target:"_blank",rel:"noopener noreferrer"}},[e._v("Demo03ProducerTest"),r("OutboundLink")],1),e._v(" 测试类，编写一个单元测试方法，发送 10 条消息，观察并发消费情况。代码如下：")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v('// Demo03ProducerTest.java\n\n@RunWith(SpringRunner.class)\n@SpringBootTest(classes = Application.class)\npublic class Demo03ProducerTest {\n\n    private Logger logger = LoggerFactory.getLogger(getClass());\n\n    @Autowired\n    private Demo03Producer producer;\n\n    @Test\n    public void testSyncSend() throws InterruptedException {\n        for (int i = 0; i < 10; i++) {\n            int id = (int) (System.currentTimeMillis() / 1000);\n            producer.syncSend(id);\n//            logger.info("[testSyncSend][发送编号：[{}] 发送成功]", id);\n        }\n\n        // 阻塞等待，保证消费\n        new CountDownLatch(1).await();\n    }\n\n}\n')])])]),r("p",[e._v("执行单元测试方法，控制台输出如下：")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("# 线程编号为 18\n2019-12-15 18:17:13.796  INFO 85887 --- [enerContainer-1] c.i.s.l.a.consumer.Demo03Consumer        : [onMessage][线程编号:18 消息内容：Demo03Message{id=1576405033}]\n2019-12-15 18:17:13.800  INFO 85887 --- [enerContainer-1] c.i.s.l.a.consumer.Demo03Consumer        : [onMessage][线程编号:18 消息内容：Demo03Message{id=1576405033}]\n2019-12-15 18:17:13.802  INFO 85887 --- [enerContainer-1] c.i.s.l.a.consumer.Demo03Consumer        : [onMessage][线程编号:18 消息内容：Demo03Message{id=1576405033}]\n2019-12-15 18:17:13.805  INFO 85887 --- [enerContainer-1] c.i.s.l.a.consumer.Demo03Consumer        : [onMessage][线程编号:18 消息内容：Demo03Message{id=1576405033}]\n2019-12-15 18:17:13.808  INFO 85887 --- [enerContainer-2] c.i.s.l.a.consumer.Demo03Consumer        : [onMessage][线程编号:21 消息内容：Demo03Message{id=1576405033}]\n\n# 线程编号 18\n2019-12-15 18:17:13.796  INFO 85887 --- [enerContainer-2] c.i.s.l.a.consumer.Demo03Consumer        : [onMessage][线程编号:21 消息内容：Demo03Message{id=1576405033}]\n2019-12-15 18:17:13.800  INFO 85887 --- [enerContainer-2] c.i.s.l.a.consumer.Demo03Consumer        : [onMessage][线程编号:21 消息内容：Demo03Message{id=1576405033}]\n2019-12-15 18:17:13.804  INFO 85887 --- [enerContainer-2] c.i.s.l.a.consumer.Demo03Consumer        : [onMessage][线程编号:21 消息内容：Demo03Message{id=1576405033}]\n2019-12-15 18:17:13.807  INFO 85887 --- [enerContainer-1] c.i.s.l.a.consumer.Demo03Consumer        : [onMessage][线程编号:18 消息内容：Demo03Message{id=1576405033}]\n2019-12-15 18:17:13.811  INFO 85887 --- [enerContainer-1] c.i.s.l.a.consumer.Demo03Consumer        : [onMessage][线程编号:18 消息内容：Demo03Message{id=1576405033}]\n")])])]),r("ul",[r("li",[e._v("我们可以看到，两个线程在消费 "),r("code",[e._v('"QUEUE_DEMO_09"')]),e._v(" 下的消息。")])]),e._v(" "),r("p",[e._v("此时，如果我们使用 "),r("a",{attrs:{href:"https://activemq.apache.org/web-console",target:"_blank",rel:"noopener noreferrer"}},[e._v("ActiveMQ Web Console"),r("OutboundLink")],1),e._v(" 来查看 "),r("code",[e._v('"QUEUE_DEMO_03"')]),e._v(" 的消费者列表：")]),e._v(" "),r("p",[r("img",{attrs:{src:"https://raw.githubusercontent.com/lichengcan/images/main/image-20231214143837954.png",alt:""}})]),e._v(" "),r("h1",{attrs:{id:"_7-顺序消息"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_7-顺序消息"}},[e._v("#")]),e._v(" 7. 顺序消息")]),e._v(" "),r("blockquote",[r("p",[e._v("示例代码对应仓库："),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-32/lab-32-activemq-demo-orderly",target:"_blank",rel:"noopener noreferrer"}},[e._v("lab-32-activemq-demo-orderly"),r("OutboundLink")],1)])]),e._v(" "),r("p",[e._v("我们先来一起了解下顺序消息的"),r("strong",[e._v("顺序消息")]),e._v("的定义：")]),e._v(" "),r("ul",[r("li",[e._v("普通顺序消息 ：Producer 将相关联的消息发送到相同的消息队列。")]),e._v(" "),r("li",[e._v("完全严格顺序 ：在【普通顺序消息】的基础上，Consumer 严格顺序消费。")])]),e._v(" "),r("p",[e._v("那么，让我们来思考下，如果我们希望在 ActiveMQ 上，实现顺序消息需要做两个事情。")]),e._v(" "),r("p",[e._v("① "),r("strong",[e._v("事情一")]),e._v("，我们需要保证 ActiveMQ Producer 发送相关联的消息发送到相同的 Queue 中。例如说，我们要发送用户信息发生变更的 Message ，那么如果我们希望使用顺序消息的情况下，可以将"),r("strong",[e._v("用户编号")]),e._v("相同的消息发送到相同的 Queue 中。")]),e._v(" "),r("p",[e._v("② "),r("strong",[e._v("事情二")]),e._v("，我们在有"),r("strong",[e._v("且仅启动一个")]),e._v(" Consumer 消费该队列，保证 Consumer 严格顺序消费。")]),e._v(" "),r("p",[e._v("不过如果这样做，会存在两个问题，我们逐个来看看。")]),e._v(" "),r("p",[e._v("① "),r("strong",[e._v("问题一")]),e._v("，正如我们在"),r("a",{attrs:{href:"https://www.iocoder.cn/Spring-Boot/ActiveMQ/?self#",target:"_blank",rel:"noopener noreferrer"}},[e._v("「6. 并发消费」"),r("OutboundLink")],1),e._v("中提到，如果我们将消息仅仅投递到一个 Queue 中，并且采用单个 Consumer "),r("strong",[e._v("串行")]),e._v("消费，在监听的 Queue 每秒消息量比较大的时候，会导致消费不及时，导致消息积压的问题。")]),e._v(" "),r("p",[e._v("此时，我们有两种方案来解决：")]),e._v(" "),r("ul",[r("li",[e._v("方案一，在 Producer 端，将 Queue 拆成多个"),r("strong",[e._v("子")]),e._v(" Queue 。假设原先 Queue 是 "),r("code",[e._v("QUEUE_USER")]),e._v(" ，那么我们就分拆成 "),r("code",[e._v("QUEUE_USER_00")]),e._v(" 至 "),r("code",[e._v("QUEUE_USER_..${N-1}")]),e._v(" 这样 N 个队列，然后基于消息的用户编号取余，路由到对应的"),r("strong",[e._v("子")]),e._v(" Queue 中。")]),e._v(" "),r("li",[e._v("方案二，在 Consumer 端，将 Queue 拉取到的消息，将相关联的消息发送到"),r("strong",[e._v("相同的线程")]),e._v("中来消费。例如说，还是 Queue 是 "),r("code",[e._v("QUEUE_USER")]),e._v(" 的例子，我们创建 N 个线程池大小为 1 的 "),r("a",{attrs:{href:"https://github.com/JetBrains/jdk8u_jdk/blob/master/src/share/classes/java/util/concurrent/ExecutorService.java",target:"_blank",rel:"noopener noreferrer"}},[e._v("ExecutorService"),r("OutboundLink")],1),e._v(" 数组，然后基于消息的用户编号取余，提交到对应的 ExecutorService 中的单个线程来执行。")])]),e._v(" "),r("p",[e._v("两个方案，并不冲突，可以结合使用。")]),e._v(" "),r("p",[e._v("② "),r("strong",[e._v("问题二")]),e._v("，如果我们启动相同 Consumer 的"),r("strong",[e._v("多个进程")]),e._v("，会导致相同 Queue 的消息被分配到多个 Consumer 进行消费，破坏 Consumer 严格顺序消费。")]),e._v(" "),r("p",[e._v("此时，我们有两种方案来解决：")]),e._v(" "),r("ul",[r("li",[e._v("方案一，引入 Zookeeper 来协调，动态设置多个进程中的"),r("strong",[e._v("相同的")]),e._v(" Consumer 的开关，保证有且仅有一个 Consumer 开启对"),r("strong",[e._v("同一个")]),e._v(" Queue 的消费。")]),e._v(" "),r("li",[e._v("方案二，仅适用于【问题一】的【方案一】。还是引入 Zookeeper 来协调，动态设置多个进程中的"),r("strong",[e._v("相同的")]),e._v(" Consumer 消费的 Queue 的分配，保证有且仅有一个 Consumer 开启对"),r("strong",[e._v("同一个")]),e._v(" Queue 的消费。")])]),e._v(" "),r("p",[e._v("下面，我们开始本小节的示例。本示例就是上述举例的具体实现。考虑到不污染上述的示例，我们新建一个 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-32/lab-32-activemq-demo-orderly",target:"_blank",rel:"noopener noreferrer"}},[e._v("lab-32-activemq-demo-orderly"),r("OutboundLink")],1),e._v(" 项目。")]),e._v(" "),r("ul",[r("li",[e._v("对于问题一，我们采用方案一。因为在 Spring-JMS 中，自己定义线程来消费消息，无法和现有的 "),r("a",{attrs:{href:"https://github.com/spring-projects/spring-framework/blob/master/spring-jms/src/main/java/org/springframework/jms/listener/DefaultMessageListenerContainer.java",target:"_blank",rel:"noopener noreferrer"}},[e._v("DefaultMessageListenerContainer"),r("OutboundLink")],1),e._v(" 的实现所结合，除非自定义一个 MessageListenerContainer 实现类。")]),e._v(" "),r("li",[e._v("对于问题二，因为实现起来比较复杂，暂时先不提供。")])]),e._v(" "),r("h2",{attrs:{id:"_7-1-引入依赖"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_7-1-引入依赖"}},[e._v("#")]),e._v(" 7.1 引入依赖")]),e._v(" "),r("p",[e._v("和 "),r("a",{attrs:{href:"https://www.iocoder.cn/Spring-Boot/ActiveMQ/?self#",target:"_blank",rel:"noopener noreferrer"}},[e._v("「3.1 引入依赖」"),r("OutboundLink")],1),e._v(" 一致，见 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-32/lab-32-activemq-demo-orderly/pom.xml",target:"_blank",rel:"noopener noreferrer"}},[r("code",[e._v("pom.xml")]),r("OutboundLink")],1),e._v(" 文件。")]),e._v(" "),r("h2",{attrs:{id:"_7-2-应用配置文件"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_7-2-应用配置文件"}},[e._v("#")]),e._v(" 7.2 应用配置文件")]),e._v(" "),r("p",[e._v("和 "),r("a",{attrs:{href:"https://www.iocoder.cn/Spring-Boot/ActiveMQ/?self#",target:"_blank",rel:"noopener noreferrer"}},[e._v("「3.2 应用配置文件」"),r("OutboundLink")],1),e._v(" 一致，见 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-32/lab-32-activemq-demo-orderly/src/main/resources/application.yaml",target:"_blank",rel:"noopener noreferrer"}},[r("code",[e._v("application.yaml")]),r("OutboundLink")],1),e._v(" 文件。")]),e._v(" "),r("h2",{attrs:{id:"_7-3-demo04message"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_7-3-demo04message"}},[e._v("#")]),e._v(" 7.3 Demo04Message")]),e._v(" "),r("p",[e._v("在 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-32/lab-32-activemq-demo-message-model/src/main/java/cn/iocoder/springboot/lab32/activemqdemo/message/",target:"_blank",rel:"noopener noreferrer"}},[r("code",[e._v("cn.iocoder.springboot.lab32.activemqdemo.message")]),r("OutboundLink")],1),e._v(" 包下，创建 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-32/lab-32-activemq-demo-orderly/src/main/java/cn/iocoder/springboot/lab32/activemqdemo/message/Demo04Message.java",target:"_blank",rel:"noopener noreferrer"}},[e._v("Demo04Message"),r("OutboundLink")],1),e._v(" 消息类，提供给当前示例使用。代码如下：")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v('// Demo04Message.java\n\npublic class Demo04Message implements Serializable {\n\n    public static final String QUEUE_BASE = "QUEUE_DEMO_04-";\n    public static final String QUEUE_0 = QUEUE_BASE + "0";\n    public static final String QUEUE_1 = QUEUE_BASE + "1";\n    public static final String QUEUE_2 = QUEUE_BASE + "2";\n    public static final String QUEUE_3 = QUEUE_BASE + "3";\n\n    public static final int QUEUE_COUNT = 4;\n\n    /**\n     * 编号\n     */\n    private Integer id;\n\n    // ... 省略 set/get/toString 方法\n\n}\n')])])]),r("ul",[r("li",[e._v("定义了 "),r("code",[e._v("QUEUE_DEMO_04-")]),e._v(" 的四个"),r("strong",[e._v("子")]),e._v(" Queue 。")])]),e._v(" "),r("h2",{attrs:{id:"_7-4-demo04producer"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_7-4-demo04producer"}},[e._v("#")]),e._v(" 7.4 Demo04Producer")]),e._v(" "),r("p",[e._v("在 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-32/lab-32-activemq-demo-orderly/src/main/java/cn/iocoder/springboot/lab32/activemqdemo/producer",target:"_blank",rel:"noopener noreferrer"}},[r("code",[e._v("cn.iocoder.springboot.lab32.activemqdemo.producer")]),r("OutboundLink")],1),e._v(" 包下，创建 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-32/lab-32-activemq-demo-orderly/src/main/java/cn/iocoder/springboot/lab32/activemqdemo/producer/Demo04Producer.java",target:"_blank",rel:"noopener noreferrer"}},[e._v("Demo04Producer"),r("OutboundLink")],1),e._v(" 类，它会使用 Spring-JMS 封装提供的 JmsMessagingTemplate ，实现发送消息到"),r("strong",[e._v("子")]),e._v(" Queue 中。代码如下：")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("// Demo04Producer.java\n\n@Component\npublic class Demo04Producer {\n\n    @Autowired\n    private JmsMessagingTemplate jmsTemplate;\n\n    public void syncSend(Integer id) {\n        // 创建 Demo04Message 消息\n        Demo04Message message = new Demo04Message();\n        message.setId(id);\n        // 同步发送消息\n        jmsTemplate.convertAndSend(this.getQueue(id), message);\n    }\n\n    private String getQueue(Integer id) {\n        return Demo04Message.QUEUE_BASE + (id % Demo04Message.QUEUE_COUNT);\n    }\n\n}\n")])])]),r("ul",[r("li",[e._v("发送消息时，我们对 "),r("code",[e._v("Demo04Message.id % 队列编号")]),e._v(" 进行取余，获得"),r("strong",[e._v("队列编号")]),e._v("作为 Queue 后缀，从而获得到对应的"),r("strong",[e._v("子")]),e._v(" Queue 中。")])]),e._v(" "),r("h2",{attrs:{id:"_7-5-demo04consumer"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_7-5-demo04consumer"}},[e._v("#")]),e._v(" 7.5 Demo04Consumer")]),e._v(" "),r("p",[e._v("在 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-32/lab-32-activemq-demo-orderly/src/main/java/cn/iocoder/springboot/lab32/activemqdemo/consumer",target:"_blank",rel:"noopener noreferrer"}},[r("code",[e._v("cn.iocoder.springboot.lab32.activemqdemo.consumer")]),r("OutboundLink")],1),e._v(" 包下，创建 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-32/lab-32-activemq-demo-orderly/src/main/java/cn/iocoder/springboot/lab32/activemqdemo/consumer/Demo04Consumer.java",target:"_blank",rel:"noopener noreferrer"}},[e._v("Demo04Consumer"),r("OutboundLink")],1),e._v(" 类，"),r("strong",[e._v("严格")]),e._v("消费"),r("strong",[e._v("顺序")]),e._v("消息。代码如下：")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v('// Demo04Consumer.java\n\n@Component\npublic class Demo04Consumer {\n\n    private Logger logger = LoggerFactory.getLogger(getClass());\n\n    @JmsListener(destination = Demo04Message.QUEUE_0)\n    @JmsListener(destination = Demo04Message.QUEUE_1)\n    @JmsListener(destination = Demo04Message.QUEUE_2)\n    @JmsListener(destination = Demo04Message.QUEUE_3)\n    public void onMessage(Demo04Message message) {\n        logger.info("[onMessage][线程编号:{} 消息内容：{}]", Thread.currentThread().getId(), message);\n    }\n\n}\n')])])]),r("ul",[r("li",[e._v("为了实现每个"),r("strong",[e._v("子")]),e._v(" Queue 能够被每个 Consumer "),r("strong",[e._v("串行")]),e._v("消费，从而实现基于"),r("strong",[e._v("子")]),e._v(" Queue 的"),r("strong",[e._v("并行")]),e._v("的"),r("strong",[e._v("严格")]),e._v("消费"),r("strong",[e._v("顺序")]),e._v("消息，我们只好在类上添了四个 "),r("code",[e._v("@JmsListener")]),e._v(" 注解，每个对应一个"),r("strong",[e._v("子")]),e._v(" Queue 。")]),e._v(" "),r("li",[e._v("如果胖友使用一个 "),r("code",[e._v("@JmsListener")]),e._v(" 注解，并添加四个"),r("strong",[e._v("子")]),e._v(" Queue ，然后设置 "),r("code",[e._v("concurrency = 4")]),e._v(" 时，实际是并发四个线程，消费四个"),r("strong",[e._v("子")]),e._v(" Queue 的消息，无法保证"),r("strong",[e._v("严格")]),e._v("消费"),r("strong",[e._v("顺序")]),e._v("消息。")])]),e._v(" "),r("h2",{attrs:{id:"_7-6-简单测试"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_7-6-简单测试"}},[e._v("#")]),e._v(" 7.6 简单测试")]),e._v(" "),r("p",[e._v("创建 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-32/lab-32-activemq-demo-orderly/src/test/java/cn/iocoder/springboot/lab32/activemqdemo/producer/Demo04ProducerTest.java",target:"_blank",rel:"noopener noreferrer"}},[e._v("Demo04ProducerTest"),r("OutboundLink")],1),e._v(" 测试类，编写一个单元测试方法，发送 8 条消息，观察顺序消费情况。代码如下：")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v('// Demo04ProducerTest.java\n\n@RunWith(SpringRunner.class)\n@SpringBootTest(classes = Application.class)\npublic class Demo04ProducerTest {\n\n    private Logger logger = LoggerFactory.getLogger(getClass());\n\n    @Autowired\n    private Demo04Producer producer;\n\n    @Test\n    public void testSyncSend() throws InterruptedException {\n        for (int i = 0; i < 2; i++) {\n            for (int id = 0; id < 4; id++) {\n                producer.syncSend(id);\n//                logger.info("[testSyncSend][发送编号：[{}] 发送成功]", id);\n            }\n        }\n\n        // 阻塞等待，保证消费\n        new CountDownLatch(1).await();\n    }\n\n}\n')])])]),r("ul",[r("li",[e._v("发送 2 轮消息，每一轮消息的编号都是 0 至 3 。")])]),e._v(" "),r("p",[e._v("执行单元测试方法，控制台输出如下：")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("# 线程编号为 21\n2019-12-15 21:44:05.582  INFO 90457 --- [enerContainer-1] c.i.s.l.a.consumer.Demo04Consumer        : [onMessage][线程编号:21 消息内容：Demo04Message{id=0}]\n2019-12-15 21:44:05.599  INFO 90457 --- [enerContainer-1] c.i.s.l.a.consumer.Demo04Consumer        : [onMessage][线程编号:21 消息内容：Demo04Message{id=0}]\n\n# 线程编号为 18\n2019-12-15 21:44:05.591  INFO 90457 --- [enerContainer-1] c.i.s.l.a.consumer.Demo04Consumer        : [onMessage][线程编号:18 消息内容：Demo04Message{id=2}]\n2019-12-15 21:44:05.605  INFO 90457 --- [enerContainer-1] c.i.s.l.a.consumer.Demo04Consumer        : [onMessage][线程编号:18 消息内容：Demo04Message{id=2}]\n\n# 线程编号为 20\n2019-12-15 21:44:05.597  INFO 90457 --- [enerContainer-1] c.i.s.l.a.consumer.Demo04Consumer        : [onMessage][线程编号:20 消息内容：Demo04Message{id=3}\n2019-12-15 21:44:05.606  INFO 90457 --- [enerContainer-1] c.i.s.l.a.consumer.Demo04Consumer        : [onMessage][线程编号:20 消息内容：Demo04Message{id=3}]\n\n# 线程编号为 19\n2019-12-15 21:44:05.583  INFO 90457 --- [enerContainer-1] c.i.s.l.a.consumer.Demo04Consumer        : [onMessage][线程编号:19 消息内容：Demo04Message{id=1}]\n2019-12-15 21:44:05.602  INFO 90457 --- [enerContainer-1] c.i.s.l.a.consumer.Demo04Consumer        : [onMessage][线程编号:19 消息内容：Demo04Message{id=1}]\n")])])]),r("ul",[r("li",[e._v("相同编号的消息，被投递到相同的"),r("strong",[e._v("子")]),e._v(" Queue ，被相同的线程所消费。符合预期~")])]),e._v(" "),r("h1",{attrs:{id:"_8-消费重试"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_8-消费重试"}},[e._v("#")]),e._v(" 8. 消费重试")]),e._v(" "),r("blockquote",[r("p",[e._v("示例代码对应仓库："),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-32/lab-32-activemq-demo-consume-retry",target:"_blank",rel:"noopener noreferrer"}},[e._v("lab-32-activemq-demo-consume-retry"),r("OutboundLink")],1)])]),e._v(" "),r("p",[e._v("在消息"),r("strong",[e._v("消费失败")]),e._v("的时候，ActiveMQ 会通过"),r("strong",[e._v("自带的")]),e._v(" "),r("a",{attrs:{href:"https://activemq.apache.org/message-redelivery-and-dlq-handling",target:"_blank",rel:"noopener noreferrer"}},[e._v("ReDelivery(重新投递)"),r("OutboundLink")],1),e._v(" 机制，重新投递该消息给 Consumer ，让 Consumer 有机会重新消费消息，实现消费成功。")]),e._v(" "),r("p",[e._v("当然，ActiveMQ 并不会无限重新投递消息给 Consumer 重新消费，而是在默认情况下，达到 N 次重试次数时，Consumer 还是消费失败时，该消息就会进入到"),r("strong",[e._v("死信队列")]),e._v("(默认为 "),r("code",[e._v('"ActiveMQ.DLQ"')]),e._v(" 队列)。后续，我们可以通过对死信队列中的消息进行重发，来使得消费者实例再次进行消费。")]),e._v(" "),r("p",[e._v("另外，每条消息的失败重试，是可以配置一定的"),r("strong",[e._v("间隔时间")]),e._v("。具体，我们在示例的代码中，来进行具体的解释。")]),e._v(" "),r("p",[e._v("下面，我们来实现一个 Consumer 消费重试的示例。考虑到不污染上述的示例，我们新建一个 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-32/lab-32-activemq-demo-consume-retry",target:"_blank",rel:"noopener noreferrer"}},[e._v("lab-32-activemq-demo-consume-retry"),r("OutboundLink")],1),e._v(" 项目。")]),e._v(" "),r("h2",{attrs:{id:"_8-1-引入依赖"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_8-1-引入依赖"}},[e._v("#")]),e._v(" 8.1 引入依赖")]),e._v(" "),r("p",[e._v("和 "),r("a",{attrs:{href:"https://www.iocoder.cn/Spring-Boot/ActiveMQ/?self#",target:"_blank",rel:"noopener noreferrer"}},[e._v("「3.1 引入依赖」"),r("OutboundLink")],1),e._v(" 一致，见 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-32/lab-32-activemq-demo-consume-retry/pom.xml",target:"_blank",rel:"noopener noreferrer"}},[r("code",[e._v("pom.xml")]),r("OutboundLink")],1),e._v(" 文件。")]),e._v(" "),r("h2",{attrs:{id:"_8-2-应用配置文件"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_8-2-应用配置文件"}},[e._v("#")]),e._v(" 8.2 应用配置文件")]),e._v(" "),r("p",[e._v("和 "),r("a",{attrs:{href:"https://www.iocoder.cn/Spring-Boot/ActiveMQ/?self#",target:"_blank",rel:"noopener noreferrer"}},[e._v("「3.1.2 应用配置文件」"),r("OutboundLink")],1),e._v(" 一致，见 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-32/lab-32-activemq-demo-consume-retry/src/main/resources/application.yaml",target:"_blank",rel:"noopener noreferrer"}},[r("code",[e._v("application.yaml")]),r("OutboundLink")],1),e._v(" 文件。")]),e._v(" "),r("h2",{attrs:{id:"_8-3-activemqconfig"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_8-3-activemqconfig"}},[e._v("#")]),e._v(" 8.3 ActiveMQConfig")]),e._v(" "),r("p",[e._v("在 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-32/lab-32-activemq-demo-consume-retry/src/main/java/cn/iocoder/springboot/lab32/activemqdemo/config",target:"_blank",rel:"noopener noreferrer"}},[r("code",[e._v("cn.iocoder.springboot.lab32.activemqdemo.config")]),r("OutboundLink")],1),e._v(" 包下，创建 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-32/lab-32-activemq-demo-consume-retry/src/main/java/cn/iocoder/springboot/lab32/activemqdemo/config/ActiveMQConfig.java",target:"_blank",rel:"noopener noreferrer"}},[e._v("ActiveMQConfig"),r("OutboundLink")],1),e._v(" 类，实现 "),r("a",{attrs:{href:"https://github.com/spring-projects/spring-boot/blob/master/spring-boot-project/spring-boot-autoconfigure/src/main/java/org/springframework/boot/autoconfigure/jms/activemq/ActiveMQConnectionFactoryCustomizer.java",target:"_blank",rel:"noopener noreferrer"}},[e._v("ActiveMQConnectionFactoryCustomizer"),r("OutboundLink")],1),e._v(" 接口，可以对 Spring Boot 自动创建的 "),r("a",{attrs:{href:"https://github.com/apache/activemq/blob/master/activemq-client/src/main/java/org/apache/activemq/ActiveMQConnectionFactory.java",target:"_blank",rel:"noopener noreferrer"}},[e._v("ActiveMQConnectionFactory"),r("OutboundLink")],1),e._v(" 进行"),r("strong",[e._v("自定义配置")]),e._v("。代码如下：")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v('// ActiveMQConfig.java\n\n@Configuration\npublic class ActiveMQConfig implements ActiveMQConnectionFactoryCustomizer {\n\n    private Logger logger = LoggerFactory.getLogger(getClass());\n\n    @Override\n    public void customize(ActiveMQConnectionFactory factory) {\n        logger.info("[customize][默认重试策略: {}]", factory.getRedeliveryPolicy());\n    }\n\n}\n')])])]),r("ul",[r("li",[r("p",[e._v("默认情况下，已经开启 ActiveMQ ReDelivery 机制。这里，我们先打印下默认的 "),r("a",{attrs:{href:"https://github.com/apache/activemq/blob/master/activemq-client/src/main/java/org/apache/activemq/RedeliveryPolicy.java",target:"_blank",rel:"noopener noreferrer"}},[e._v("RedeliveryPolicy"),r("OutboundLink")],1),e._v(" 重投策略。如下：")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("2019-12-15 23:01:41.406  INFO 93850 --- [           main] QConfig$$EnhancerBySpringCGLIB$$13367ef1 : [customize][默认重试策略: RedeliveryPolicy {destination = null, collisionAvoidanceFactor = 0.15, maximumRedeliveries = 6, maximumRedeliveryDelay = -1, initialRedeliveryDelay = 1000, useCollisionAvoidance = false, useExponentialBackOff = false, backOffMultiplier = 5.0, redeliveryDelay = 1000, preDispatchCheck = true}]\n")])])]),r("ul",[r("li",[e._v("默认重投 6 次，每次间隔 1000 毫秒。")])])]),e._v(" "),r("li",[r("p",[e._v("如果胖友想要创建 RedeliveryPolicy 对象，自定义重投策略。更多可以参考 "),r("a",{attrs:{href:"https://activemq.apache.org/redelivery-policy",target:"_blank",rel:"noopener noreferrer"}},[e._v("《ActiveMQ 文档 —— Redelivery Policy》"),r("OutboundLink")],1),e._v(" 。")])])]),e._v(" "),r("h2",{attrs:{id:"_8-4-demo05message"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_8-4-demo05message"}},[e._v("#")]),e._v(" 8.4 Demo05Message")]),e._v(" "),r("p",[e._v("在 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-32/lab-32-activemq-demo-consume-retry/src/main/java/cn/iocoder/springboot/lab32/activemqdemo/message",target:"_blank",rel:"noopener noreferrer"}},[r("code",[e._v("cn.iocoder.springboot.lab32.activemqdemo.message")]),r("OutboundLink")],1),e._v(" 包下，创建 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-32/lab-32-activemq-demo-consume-retry/src/main/java/cn/iocoder/springboot/lab32/activemqdemo/message/Demo05Message.java",target:"_blank",rel:"noopener noreferrer"}},[e._v("Demo05Message"),r("OutboundLink")],1),e._v(" 消息类，提供给当前示例使用。")]),e._v(" "),r("p",[e._v("和"),r("a",{attrs:{href:"https://www.iocoder.cn/Spring-Boot/ActiveMQ/?self#",target:"_blank",rel:"noopener noreferrer"}},[e._v("「3.4 Demo01Message」"),r("OutboundLink")],1),e._v("一致，只是 Queue 名字不同。")]),e._v(" "),r("h2",{attrs:{id:"_8-5-demo05producer"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_8-5-demo05producer"}},[e._v("#")]),e._v(" 8.5 Demo05Producer")]),e._v(" "),r("p",[e._v("在 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-32/lab-32-activemq-demo-consume-retry/src/main/java/cn/iocoder/springboot/lab32/activemqdemo/producer",target:"_blank",rel:"noopener noreferrer"}},[r("code",[e._v("cn.iocoder.springboot.lab32.activemqdemo.producer")]),r("OutboundLink")],1),e._v(" 包下，创建 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-32/lab-32-activemq-demo-consume-retry/src/main/java/cn/iocoder/springboot/lab32/activemqdemo/producer/Demo05Producer.java",target:"_blank",rel:"noopener noreferrer"}},[e._v("Demo05Producer"),r("OutboundLink")],1),e._v(" 类，它会使用 Spring-JMS 封装提供的 JmsMessagingTemplate ，实现发送消息。")]),e._v(" "),r("p",[e._v("和"),r("a",{attrs:{href:"https://www.iocoder.cn/Spring-Boot/ActiveMQ/?self#",target:"_blank",rel:"noopener noreferrer"}},[e._v("「3.5 Demo01Producer」"),r("OutboundLink")],1),e._v("一致，只是 Queue 名字不同。")]),e._v(" "),r("h2",{attrs:{id:"_8-6-demo05consumer"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_8-6-demo05consumer"}},[e._v("#")]),e._v(" 8.6 Demo05Consumer")]),e._v(" "),r("p",[e._v("在 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-32/lab-32-activemq-demo-consume-retry/src/main/java/cn/iocoder/springboot/lab32/activemqdemo/consumer",target:"_blank",rel:"noopener noreferrer"}},[r("code",[e._v("cn.iocoder.springboot.lab32.activemqdemo.consumer")]),r("OutboundLink")],1),e._v(" 包下，创建 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/tree/master/lab-32/lab-32-activemq-demo-consume-retry/src/main/java/cn/iocoder/springboot/lab32/activemqdemo/consumer/Demo05Consumer.java",target:"_blank",rel:"noopener noreferrer"}},[e._v("Demo05Consumer"),r("OutboundLink")],1),e._v(" 类，消费消息。代码如下：")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v('// Demo05Consumer.java\n\n@Component\npublic class Demo05Consumer {\n\n    private Logger logger = LoggerFactory.getLogger(getClass());\n\n    @JmsListener(destination = Demo05Message.QUEUE)\n    public void onMessage(Demo05Message message) {\n        logger.info("[onMessage][线程编号:{} 消息内容：{}]", Thread.currentThread().getId(), message);\n        // <X> 注意，此处抛出一个 RuntimeException 异常，模拟消费失败\n        throw new RuntimeException("我就是故意抛出一个异常");\n    }\n\n}\n')])])]),r("ul",[r("li",[e._v("在 "),r("code",[e._v("<X>")]),e._v(" 处，我们在消费消息时候，抛出一个 RuntimeException 异常，模拟消费失败。")])]),e._v(" "),r("h2",{attrs:{id:"_8-7-简单测试"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#_8-7-简单测试"}},[e._v("#")]),e._v(" 8.7 简单测试")]),e._v(" "),r("p",[e._v("创建 "),r("a",{attrs:{href:"https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-32/lab-32-activemq-demo-consume-retry/src/test/java/cn/iocoder/springboot/lab32/activemqdemo/producer/Demo05ProducerTest.java",target:"_blank",rel:"noopener noreferrer"}},[e._v("Demo05ProducerTest"),r("OutboundLink")],1),e._v(" 测试类，编写单元测试方法，测试"),r("strong",[e._v("消费重试")]),e._v("的效果。代码如下：")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v('// Demo05ProducerTest.java\n\n@RunWith(SpringRunner.class)\n@SpringBootTest(classes = Application.class)\npublic class Demo05ProducerTest {\n\n    private Logger logger = LoggerFactory.getLogger(getClass());\n\n    @Autowired\n    private Demo05Producer producer;\n\n    @Test\n    public void testSyncSend() throws InterruptedException {\n        // 发送消息\n        int id = (int) (System.currentTimeMillis() / 1000);\n        producer.syncSend(id);\n        logger.info("[testSyncSend][发送编号：[{}] 发送成功]", id);\n\n        // 阻塞等待，保证消费\n        new CountDownLatch(1).await();\n    }\n\n}\n')])])]),r("p",[e._v("我们来执行 "),r("code",[e._v("#testSyncSend()")]),e._v(" 方法，测试 Consumer 消费重试的效果。控制台输出如下：")]),e._v(" "),r("div",{staticClass:"language- extra-class"},[r("pre",{pre:!0,attrs:{class:"language-text"}},[r("code",[e._v("// Producer 同步发送消息成功。\n2019-12-15 23:04:26.865  INFO 94045 --- [           main] c.i.s.l.a.producer.Demo05ProducerTest    : [testSyncSend][发送编号：[1576422266] 发送成功]\n\n// Consumer 第 1 次消费\n2019-12-15 23:04:26.868  INFO 94045 --- [enerContainer-1] c.i.s.l.a.consumer.Demo05Consumer        : [onMessage][线程编号:18 消息内容：Demo05Message{id=1576422266}]\n2019-12-15 23:04:26.877  WARN 94045 --- [enerContainer-1] o.s.j.l.DefaultMessageListenerContainer  : Execution of JMS message listener failed, and no ErrorHandler has been set.\n\norg.springframework.jms.listener.adapter.ListenerExecutionFailedException: Listener method 'public void cn.iocoder.springboot.lab32.activemqdemo.consumer.Demo05Consumer.onMessage(cn.iocoder.springboot.lab32.activemqdemo.message.Demo05Message)' threw exception; nested exception is java.lang.RuntimeException: 我就是故意抛出一个异常\n    // ... 省略异常堆栈\n\n// 1 秒后，Consumer 第 1 次重试消费\n2019-12-15 23:04:27.875  INFO 94045 --- [enerContainer-1] c.i.s.l.a.consumer.Demo05Consumer        : [onMessage][线程编号:18 消息内容：Demo05Message{id=1576422266}]\n2019-12-15 23:04:27.877  WARN 94045 --- [enerContainer-1] o.s.j.l.DefaultMessageListenerContainer  : Execution of JMS message listener failed, and no ErrorHandler has been set.\n\norg.springframework.jms.listener.adapter.ListenerExecutionFailedException: Listener method 'public void cn.iocoder.springboot.lab32.activemqdemo.consumer.Demo05Consumer.onMessage(cn.iocoder.springboot.lab32.activemqdemo.message.Demo05Message)' threw exception; nested exception is java.lang.RuntimeException: 我就是故意抛出一个异常\n    // ... 省略异常堆栈\n\n// 1 秒后，Consumer 第 2 次重试消费\n2019-12-15 23:04:28.878  INFO 94045 --- [enerContainer-1] c.i.s.l.a.consumer.Demo05Consumer        : [onMessage][线程编号:18 消息内容：Demo05Message{id=1576422266}]\n2019-12-15 23:04:28.879  WARN 94045 --- [enerContainer-1] o.s.j.l.DefaultMessageListenerContainer  : Execution of JMS message listener failed, and no ErrorHandler has been set.\n\norg.springframework.jms.listener.adapter.ListenerExecutionFailedException: Listener method 'public void cn.iocoder.springboot.lab32.activemqdemo.consumer.Demo05Consumer.onMessage(cn.iocoder.springboot.lab32.activemqdemo.message.Demo05Message)' threw exception; nested exception is java.lang.RuntimeException: 我就是故意抛出一个异常\n    // ... 省略异常堆栈\n\n// 1 秒后，Consumer 第 3 次重试消费\n2019-12-15 23:04:29.884  INFO 94045 --- [enerContainer-1] c.i.s.l.a.consumer.Demo05Consumer        : [onMessage][线程编号:18 消息内容：Demo05Message{id=1576422266}]\n2019-12-15 23:04:29.887  WARN 94045 --- [enerContainer-1] o.s.j.l.DefaultMessageListenerContainer  : Execution of JMS message listener failed, and no ErrorHandler has been set.\n\norg.springframework.jms.listener.adapter.ListenerExecutionFailedException: Listener method 'public void cn.iocoder.springboot.lab32.activemqdemo.consumer.Demo05Consumer.onMessage(cn.iocoder.springboot.lab32.activemqdemo.message.Demo05Message)' threw exception; nested exception is java.lang.RuntimeException: 我就是故意抛出一个异常\n    // ... 省略异常堆栈\n\n// 1 秒后，Consumer 第 4 次重试消费\n2019-12-15 23:04:30.887  INFO 94045 --- [enerContainer-1] c.i.s.l.a.consumer.Demo05Consumer        : [onMessage][线程编号:18 消息内容：Demo05Message{id=1576422266}]\n2019-12-15 23:04:30.890  WARN 94045 --- [enerContainer-1] o.s.j.l.DefaultMessageListenerContainer  : Execution of JMS message listener failed, and no ErrorHandler has been set.\n\norg.springframework.jms.listener.adapter.ListenerExecutionFailedException: Listener method 'public void cn.iocoder.springboot.lab32.activemqdemo.consumer.Demo05Consumer.onMessage(cn.iocoder.springboot.lab32.activemqdemo.message.Demo05Message)' threw exception; nested exception is java.lang.RuntimeException: 我就是故意抛出一个异常\n    // ... 省略异常堆栈\n\n// 1 秒后，Consumer 第 5 次重试消费\n2019-12-15 23:04:31.893  INFO 94045 --- [enerContainer-1] c.i.s.l.a.consumer.Demo05Consumer        : [onMessage][线程编号:18 消息内容：Demo05Message{id=1576422266}]\n2019-12-15 23:04:31.895  WARN 94045 --- [enerContainer-1] o.s.j.l.DefaultMessageListenerContainer  : Execution of JMS message listener failed, and no ErrorHandler has been set.\n\norg.springframework.jms.listener.adapter.ListenerExecutionFailedException: Listener method 'public void cn.iocoder.springboot.lab32.activemqdemo.consumer.Demo05Consumer.onMessage(cn.iocoder.springboot.lab32.activemqdemo.message.Demo05Message)' threw exception; nested exception is java.lang.RuntimeException: 我就是故意抛出一个异常\n    // ... 省略异常堆栈\n\n// 1 秒后，Consumer 第 6 次重试消费\n2019-12-15 23:04:32.897  INFO 94045 --- [enerContainer-1] c.i.s.l.a.consumer.Demo05Consumer        : [onMessage][线程编号:18 消息内容：Demo05Message{id=1576422266}]\n2019-12-15 23:04:32.901  WARN 94045 --- [enerContainer-1] o.s.j.l.DefaultMessageListenerContainer  : Execution of JMS message listener failed, and no ErrorHandler has been set.\n\norg.springframework.jms.listener.adapter.ListenerExecutionFailedException: Listener method 'public void cn.iocoder.springboot.lab32.activemqdemo.consumer.Demo05Consumer.onMessage(cn.iocoder.springboot.lab32.activemqdemo.message.Demo05Message)' threw exception; nested exception is java.lang.RuntimeException: 我就是故意抛出一个异常\n    // ... 省略异常堆栈\n")])])]),r("ul",[r("li",[e._v("Consumer 重试消费消息 6 次，每次间隔 1 秒，全部都失败，最终该消息转发到死信队列中。")])]),e._v(" "),r("p",[e._v("此时，如果我们使用 "),r("a",{attrs:{href:"https://activemq.apache.org/web-console",target:"_blank",rel:"noopener noreferrer"}},[e._v("ActiveMQ Web Console"),r("OutboundLink")],1),e._v(" 来查看 "),r("code",[e._v('"ActiveMQ.DLQ"')]),e._v(" 的队列的消息：")]),e._v(" "),r("p",[r("img",{attrs:{src:"https://raw.githubusercontent.com/lichengcan/images/main/activemq02.png",alt:""}})]),e._v(" "),r("ul",[r("li",[r("code",[e._v('"ActiveMQ.DLQ "')]),e._v(" 队列中有 1 条消息，就是我们刚消费失败到达上限的该消息。")])])])}),[],!1,null,null,null);r.default=t.exports}}]);